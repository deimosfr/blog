

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.30 with theme Tranquilpeak 0.4.3-BETA">
    <title>Kubernetes with Traefik and Let&#39;s Encrypt</title>
    <meta name="author" content="Pierre Mavro / Deimosfr">
    <meta name="keywords" content="">

    <link rel="icon" href="https://blog.deimos.fr/favicon.png">
    

    
    <meta name="description" content="Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
I wanted to deploy it on Kubernetes for its interesting features like:
 Connect to Kubernetes API to listen changes and perform on the fly updates Automatic SSL management through Let&rsquo;s encrypt (SNI) Prometheus native integration HTTP/2 support  I really like HAProxy, but in a Kubernetes case, it&rsquo;s not the recommended solution because of its lake of features.">
    <meta property="og:description" content="Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
I wanted to deploy it on Kubernetes for its interesting features like:
 Connect to Kubernetes API to listen changes and perform on the fly updates Automatic SSL management through Let&rsquo;s encrypt (SNI) Prometheus native integration HTTP/2 support  I really like HAProxy, but in a Kubernetes case, it&rsquo;s not the recommended solution because of its lake of features.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Kubernetes with Traefik and Let&#39;s Encrypt">
    <meta property="og:url" content="/2017/08/20/kubernetes-with-traefik-and-lets-encrypt">
    <meta property="og:site_name" content="Deimosfr Blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Deimosfr Blog">
    <meta name="twitter:description" content="Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
I wanted to deploy it on Kubernetes for its interesting features like:
 Connect to Kubernetes API to listen changes and perform on the fly updates Automatic SSL management through Let&rsquo;s encrypt (SNI) Prometheus native integration HTTP/2 support  I really like HAProxy, but in a Kubernetes case, it&rsquo;s not the recommended solution because of its lake of features.">
    
      <meta name="twitter:creator" content="@deimosfr">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640">
    

    
      <meta property="og:image" content="https://blog.deimos.fr/thumbnails/logo_traefik.png">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://blog.deimos.fr/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      
        <link rel="stylesheet" href="https://blog.deimos.fr/css/custom.css">
      
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63927289-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://blog.deimos.fr/">Deimosfr Blog</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://blog.deimos.fr/#about">
    
    
    
      
        <img class="header-picture" src="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://blog.deimos.fr/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Pierre Mavro / Deimosfr</h4>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.deimos.fr" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-user"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://wiki.deimos.fr" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-wikipedia-w"></i>
      
      <span class="sidebar-button-desc">Wiki</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Kubernetes with Traefik and Let&#39;s Encrypt
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2017-08-20T14:58:07&#43;02:00">
        
  
  
  
  
    20 August 2017
  

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://blog.deimos.fr/categories/kubernetes">Kubernetes</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/ssl">SSL</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/lets-encrypt">Let&#39;s Encrypt</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/consul">Consul</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/traefik">Traefik</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p><img src="https://blog.deimos.fr/images/logo_traefik.png" alt="Traefik" /></p>

<p><a href="https://traefik.io/" target="_blank">Traefik</a> (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy
microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd,
Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.</p>

<p>I wanted to deploy it on Kubernetes for its interesting features like:</p>

<ul>
<li>Connect to Kubernetes API to listen changes and perform on the fly updates</li>
<li>Automatic SSL management through Let&rsquo;s encrypt (SNI)</li>
<li>Prometheus native integration</li>
<li>HTTP/2 support</li>
</ul>

<p>I really like HAProxy, but in a Kubernetes case, it&rsquo;s not the recommended solution because of its lake of features.
Traefik should be get less performance, but the features it provides really match Kubernetes integration.</p>

<p>First of all, I wanted to use Etcd as the backend to store SSL certificates and configuration.
However, there&rsquo;s <a href="https://github.com/containous/traefik/issues/926" target="_blank">an issue in progress</a> on the Go libkv and etcd v3.
As I&rsquo;m using Kubernetes 1.7 and etcd v3, I had to find another backend. The one I know well is consul and I decided to
switch to it while waiting the fix.</p>

<p>I&rsquo;ll show in that post how I did, to make it works. If you&rsquo;re following me, you&rsquo;ll remind that I&rsquo;m not using a cloud but
a bare metal installation of Kubernetes. As I&rsquo;m not using a shared storage for the moment, I&rsquo;m storing data locally on a
specific servers labeled:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl label nodes srv1 srv2 srv3 consul<span style="color:#f92672">=</span>server</code></pre></div></p>

<p>Then I&rsquo;ll need a headless (&lsquo;clusterIP: None&rsquo;) service to be used by a StatefulSet Consul type:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: v<span style="color:#ae81ff">1</span>
kind: Service
metadata:
  name: consul
  namespace: kube-system
  labels:
    consul: server
spec:
  clusterIP: None
  ports:
    - name: http
      port: <span style="color:#ae81ff">8500</span>
      targetPort: <span style="color:#ae81ff">8500</span>
    - name: https
      port: <span style="color:#ae81ff">8443</span>
      targetPort: <span style="color:#ae81ff">8443</span>
    - name: rpc
      port: <span style="color:#ae81ff">8400</span>
      targetPort: <span style="color:#ae81ff">8400</span>
    - name: serflan-tcp
      protocol: <span style="color:#e6db74">&#34;TCP&#34;</span>
      port: <span style="color:#ae81ff">8301</span>
      targetPort: <span style="color:#ae81ff">8301</span>
    - name: serflan-udp
      protocol: <span style="color:#e6db74">&#34;UDP&#34;</span>
      port: <span style="color:#ae81ff">8301</span>
      targetPort: <span style="color:#ae81ff">8301</span>
    - name: serfwan-tcp
      protocol: <span style="color:#e6db74">&#34;TCP&#34;</span>
      port: <span style="color:#ae81ff">8302</span>
      targetPort: <span style="color:#ae81ff">8302</span>
    - name: serfwan-udp
      protocol: <span style="color:#e6db74">&#34;UDP&#34;</span>
      port: <span style="color:#ae81ff">8302</span>
      targetPort: <span style="color:#ae81ff">8302</span>
    - name: server
      port: <span style="color:#ae81ff">8300</span>
      targetPort: <span style="color:#ae81ff">8300</span>
    - name: consuldns
      port: <span style="color:#ae81ff">8600</span>
      targetPort: <span style="color:#ae81ff">8600</span>
  selector:
    consul: server</code></pre></div>
This is needed to be able to access with the help of DNS to the wished instance name (ex: consul-0.consul.kube-system.svc.cluster.local).</p>

<p>Now I&rsquo;m ready to bootstrap the Consul cluster. To do so, I&rsquo;m using this StatefulSet configuration:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1beta<span style="color:#ae81ff">1</span>
kind: StatefulSet
metadata:
  name: consul
  namespace: kube-system
spec:
  serviceName: consul
  replicas: <span style="color:#ae81ff">3</span>
  template:
    metadata:
      labels:
        consul: server
    spec:
      nodeSelector:
        consul: server
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: consul
                    operator: In
                    values:
                      - server
              topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: <span style="color:#ae81ff">10</span>
      securityContext:
        fsGroup: <span style="color:#ae81ff">1000</span>
      containers:
      - name: consul
        image: consul:<span style="color:#ae81ff">0.9</span>.<span style="color:#ae81ff">2</span>
        args:
        - <span style="color:#e6db74">&#34;agent&#34;</span>
        - <span style="color:#e6db74">&#34;-advertise=$(POD_IP)&#34;</span>
        - <span style="color:#e6db74">&#34;-bind=0.0.0.0&#34;</span>
        - <span style="color:#e6db74">&#34;-bootstrap-expect=3&#34;</span>
        - <span style="color:#e6db74">&#34;-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local&#34;</span>
        - <span style="color:#e6db74">&#34;-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local&#34;</span>
        - <span style="color:#e6db74">&#34;-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local&#34;</span>
        - <span style="color:#e6db74">&#34;-client=0.0.0.0&#34;</span>
        - <span style="color:#e6db74">&#34;-datacenter=fr&#34;</span>
        - <span style="color:#e6db74">&#34;-data-dir=/consul/data&#34;</span>
        - <span style="color:#e6db74">&#34;-domain=cluster.local&#34;</span>
        - <span style="color:#e6db74">&#34;-server&#34;</span>
        - <span style="color:#e6db74">&#34;-ui&#34;</span>
        - <span style="color:#e6db74">&#34;-disable-host-node-id&#34;</span>
        ports:
        - containerPort: <span style="color:#ae81ff">8500</span>
          name: ui-port
        - containerPort: <span style="color:#ae81ff">8400</span>
          name: alt-port
        - containerPort: <span style="color:#ae81ff">53</span>
          name: udp-port
        - containerPort: <span style="color:#ae81ff">8443</span>
          name: https-port
        - containerPort: <span style="color:#ae81ff">8080</span>
          name: http-port
        - containerPort: <span style="color:#ae81ff">8301</span>
          name: serflan
        - containerPort: <span style="color:#ae81ff">8302</span>
          name: serfwan
        - containerPort: <span style="color:#ae81ff">8600</span>
          name: consuldns
        - containerPort: <span style="color:#ae81ff">8300</span>
          name: server
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - consul leave
        volumeMounts:
        - name: ca-certificates
          mountPath: /etc/ssl/certs
        - name: consul-data
          mountPath: /consul/data
      volumes:
      - name: ca-certificates
        hostPath:
          path: /usr/share/ca-certificates/
      - name: consul-data
        hostPath:
          path: /mnt/consul</code></pre></div></p>

<p>After a few seconds (look at the logs), your cluster should be ready.</p>

<p>It&rsquo;s time to prepare your Traefik configuration which we will push into Consul (Traefik is unfortunately not able to
read Kubernetes configmaps for the moment).</p>

<p>My Traefik configmap looks like this:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: v<span style="color:#ae81ff">1</span>
kind: ConfigMap
metadata:
  name: traefik
  namespace: kube-system
data:
  traefik.toml: |-
    checkNewVersion = <span style="color:#66d9ef">false</span>
    IdleTimeout = <span style="color:#e6db74">&#34;180s&#34;</span>
    MaxIdleConnsPerHost = <span style="color:#ae81ff">500</span>
    logLevel = <span style="color:#e6db74">&#34;INFO&#34;</span>
    defaultEntryPoints = [<span style="color:#e6db74">&#34;http&#34;</span>, <span style="color:#e6db74">&#34;https&#34;</span>]

    [retry]
    attempts = <span style="color:#ae81ff">3</span>

    [web]
    address = <span style="color:#e6db74">&#34;:8081&#34;</span>

    [kubernetes]
    endpoint = <span style="color:#e6db74">&#34;http://localhost:8080&#34;</span>
    namespaces = [<span style="color:#e6db74">&#34;default&#34;</span>]

    [consul]
    endpoint = <span style="color:#e6db74">&#34;consul:8500&#34;</span>
    watch = <span style="color:#66d9ef">true</span>
    prefix = <span style="color:#e6db74">&#34;traefik&#34;</span>

    [acme]
    email = <span style="color:#e6db74">&#34;my@email.here&#34;</span>
    storage = <span style="color:#e6db74">&#34;traefik/acme/account&#34;</span>
    entryPoint = <span style="color:#e6db74">&#34;https&#34;</span>
    OnHostRule = <span style="color:#66d9ef">true</span>
    onDemand = <span style="color:#66d9ef">true</span>
    acmeLogging = <span style="color:#66d9ef">true</span>
    <span style="color:#75715e">#caServer = &#34;https://acme-staging.api.letsencrypt.org/directory&#34;</span>

    [[acme.domains]]
       main = <span style="color:#e6db74">&#34;mydomain.fqdn&#34;</span>

    [entryPoints]
      [entryPoints.http]
      address = <span style="color:#e6db74">&#34;:80&#34;</span>
      compress = <span style="color:#66d9ef">true</span>
        [entryPoints.http.redirect]
        entryPoint = <span style="color:#e6db74">&#34;https&#34;</span>
      [entryPoints.https]
      address = <span style="color:#e6db74">&#34;:443&#34;</span>
        [entryPoints.https.tls]
  resolv.conf: |-
    nameserver <span style="color:#ae81ff">10.3</span>.<span style="color:#ae81ff">0.10</span>
    search kube-system.svc.cluster.local svc.cluster.local cluster.local
    options ndots:<span style="color:#ae81ff">5</span></code></pre></div>
To get more information on it, please look at the <a href="http://docs.traefik.io/toml/" target="_blank">good Traefik documentation</a>. You&rsquo;ll see why there is resolv.conf
later in this post. This Traefik configuration give the Traefik we interface on port 8081, connects to Kubernetes on
localhost and port 8080, connects to Consul using the headless service, manages let&rsquo;s encrypt certificates and redirect
http to https.</p>

<p>Note: if you just want to test, you can uncomment the caServer line. But you&rsquo;ll need to remove completely the imported
traefik configuration in Consul when you&rsquo;ll be ready to go prod (and of course remove this line).</p>

<p>Now let&rsquo;s run the job which will push this configuration into the Consul KV:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: batch/v<span style="color:#ae81ff">1</span>
kind: Job
metadata:
  name: traefik-boostrap
  namespace: kube-system
spec:
  template:
    metadata:
      name: traefik-boostrap
    spec:
      containers:
      - image: traefik:v<span style="color:#ae81ff">1.3</span>-alpine
        name: traefik-bootstrap
        args:
        - storeconfig
        - --configfile=/etc/traefik/traefik.toml
        volumeMounts:
        - name: traefik-config
          mountPath: /etc/traefik
      restartPolicy: Never
      volumes:
      - name: traefik-config
        configMap:
          name: traefik</code></pre></div></p>

<p>Traefik is now ready to be deployed. We need a service account:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: v<span style="color:#ae81ff">1</span>
kind: ServiceAccount
metadata:
  name: traefik-ingress-controller
  namespace: kube-system</code></pre></div></p>

<p>And the service for the web admin interface:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: v<span style="color:#ae81ff">1</span>
kind: Service
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
  - name: web
    port: <span style="color:#ae81ff">80</span>
    targetPort: <span style="color:#ae81ff">8081</span></code></pre></div></p>

<p>Just before deploying Traefik, there is a small bug to workaround before going ahead. A key in the Consul KV store should be
deleted:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl --namespace kube-system exec -it consul-0 consul kv delete traefik/acme/storagefile</code></pre></div></p>

<p>I&rsquo;m using a daemonset for Traefik as I want it to run on a ll my Kubernetes nodes:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">kind: DaemonSet
apiVersion: extensions/v1beta<span style="color:#ae81ff">1</span>
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      serviceAccountName: traefik-ingress-controller
      terminationGracePeriodSeconds: <span style="color:#ae81ff">60</span>
      hostNetwork: <span style="color:#66d9ef">true</span>
      containers:
      - image: traefik:v<span style="color:#ae81ff">1.3</span>-alpine
        name: traefik-ingress-lb
        command:
          - <span style="color:#e6db74">&#34;/bin/sh&#34;</span>
          - <span style="color:#e6db74">&#34;-c&#34;</span>
          - <span style="color:#e6db74">&#34;cat /etc/resolvconf/resolv.conf &gt; /etc/resolv.conf ; /entrypoint.sh --consul --consul.endpoint=consul:8500&#34;</span>
        resources:
          limits:
            cpu: 200m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 20Mi
        ports:
        - name: http
          hostPort: <span style="color:#ae81ff">80</span>
          containerPort: <span style="color:#ae81ff">80</span>
        - name: https
          hostPort: <span style="color:#ae81ff">443</span>
          containerPort: <span style="color:#ae81ff">443</span>
        - name: admin
          containerPort: <span style="color:#ae81ff">8081</span>
        securityContext:
          privileged: <span style="color:#66d9ef">true</span>
        volumeMounts:
        - name: traefik-config
          mountPath: /etc/resolvconf
      volumes:
      - name: traefik-config
        configMap:
          name: traefik
          items:
          - key: resolv.conf
            path: resolv.conf</code></pre></div>
If you&rsquo;re encountering an issue with port 443 already in use, you&rsquo;ll have to update the Kubernetes API default port to
another one.</p>

<p>You can see the resolv.conf override here because when we&rsquo;re using &ldquo;hostNetwork: true&rdquo;, we&rsquo;ll get back resolv.conf from
the host and not the one generated by Kubernetes. Without this, you won&rsquo;t be able to contact Consul endpoint.</p>

<p>Now you&rsquo;re done ! You can create ingress services :-). Here is an example of a full service:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: extensions/v1beta<span style="color:#ae81ff">1</span>
kind: Deployment
metadata:
  name: hostnames
  namespace: default
  labels:
    app: hostnames
spec:
  replicas: <span style="color:#ae81ff">3</span>
  template:
    metadata:
      labels:
        app: hostnames
    spec:
      hostNetwork: <span style="color:#66d9ef">true</span>
      containers:
      - name: hostnames
        image: gcr.io/google_containers/serve_hostname
        ports:
        - containerPort: <span style="color:#ae81ff">9376</span>
          hostPort: <span style="color:#ae81ff">9376</span>
---
apiVersion: v<span style="color:#ae81ff">1</span>
kind: Service
metadata:
  name: hostnames
  namespace: default
spec:
  selector:
    app: hostnames
  ports:
  - name: default
    port: <span style="color:#ae81ff">80</span>
    targetPort: <span style="color:#ae81ff">9376</span>
---
apiVersion: extensions/v1beta<span style="color:#ae81ff">1</span>
kind: Ingress
metadata:
  name: hostnames
  namespace: default
  annotations:
    kubernetes.io/ingress.class: <span style="color:#e6db74">&#34;traefik&#34;</span>
spec:
  rules:
  - host: test.mydomain.fqdn
    http:
      paths:
      - path: /
        backend:
          serviceName: hostnames
          servicePort: <span style="color:#ae81ff">80</span></code></pre></div></p>

<p>Connect to <a href="http://test.mydomain.fqdn" target="_blank">http://test.mydomain.fqdn</a>, you will be redirected to <a href="https://test.mydomain.fqdn" target="_blank">https://test.mydomain.fqdn</a>. The first connexion may take
some seconds because of the generation of the SSL certificate.</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/kubernetes/">Kubernetes</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/ssl/">SSL</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/lets-encrypt/">Let&#39;s Encrypt</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/consul/">Consul</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/traefik/">Traefik</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2018/01/18/mysocialapp-crate-your-own-social-network/" data-tooltip="MySocialApp Create your own social network">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2017/04/18/deploy-kubernetes-with-ansible/" data-tooltip="Deploy Kubernetes with Ansible">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2018 Pierre Mavro / Deimosfr. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2018/01/18/mysocialapp-crate-your-own-social-network/" data-tooltip="MySocialApp Create your own social network">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2017/04/18/deploy-kubernetes-with-ansible/" data-tooltip="Deploy Kubernetes with Ansible">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.deimos.fr%2F2017%2F08%2F20%2Fkubernetes-with-traefik-and-lets-encrypt%2F">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fblog.deimos.fr%2F2017%2F08%2F20%2Fkubernetes-with-traefik-and-lets-encrypt%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fblog.deimos.fr%2F2017%2F08%2F20%2Fkubernetes-with-traefik-and-lets-encrypt%2F">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Pierre Mavro / Deimosfr</h4>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        SRE Lead DevOps at Criteo &nbsp;&bull;&nbsp; MySocialApp Co-Founder
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Paris - France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
                <h3 class="media-heading">Running Cassandra in Kubernetes</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">For my own company MySocialApp, I&rsquo;m managing several Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/31/integrate-gcr-in-your-on-premise-kubernetes/">
                <h3 class="media-heading">Integrate GCR in your on premise k8s cluster</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">I&rsquo;m using Kubernetes on an on premise cluster for MySocialApp. Today, I&rsquo;m storing MySocialApp public images at Quay.io and I also wanted to store private images. I didn&rsquo;t want to bootstrap a private registry for it to avoid maintaining it, having a distributed storage to maintain for it etc&hellip;but wanted a solution at a lower cost.
I started to look at DockerHub and Quay.io. As far aas I saw, DockerHub do not provide private registry while Quay does.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/26/install-jeedom-on-synology-with-docker/">
                <h3 class="media-heading">Install Jeedom on Synology with Docker</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">The Jeedom software is open source; you have complete access to the software that manages your home automation. Jeedom is compatible with various protocols, like Z-Wave, RFXCOM, RTS SOMFY, EnOcean, xPL, etc.
Installing Jeedom on Synology with Docker it not a complex task. However for those who are not familiar with those technologies, I summarized here the installation process for a Z-wave network.
First of all, let&rsquo;s look at the requirements:</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/23/traefik-ha-helm-chart-with-le-on-k8s/">
                <h3 class="media-heading">Traefik HA Helm chart with Let&#39;s Encrypt on Kubernetes</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
In a previous post, I explained how to manually deploy it in HA mode. For MySocialApp (iOS and Android social app builder - SaaS), I had to automate it.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/18/mysocialapp-crate-your-own-social-network/">
                <h3 class="media-heading">MySocialApp Create your own social network</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">If you follow me, you may know that I launched with friends Nousmotards social application a few years ago. The solution continue to grow in France with more than 70k bikers and that&rsquo;s a good point for all those riders :)
Since we launched Nousmotards, several persons asked us: &ldquo;You&rsquo;ve made an amazing job for bikers, do you provide your social solution to any other communities or for enterprises?&rdquo;. The answer was: No we didn&rsquo;t.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
                <h3 class="media-heading">Kubernetes with Traefik and Let&#39;s Encrypt</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
I wanted to deploy it on Kubernetes for its interesting features like:
 Connect to Kubernetes API to listen changes and perform on the fly updates Automatic SSL management through Let&rsquo;s encrypt (SNI) Prometheus native integration HTTP/2 support  I really like HAProxy, but in a Kubernetes case, it&rsquo;s not the recommended solution because of its lake of features.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2017/04/18/deploy-kubernetes-with-ansible/">
                <h3 class="media-heading">Deploy Kubernetes with Ansible</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications. I&rsquo;m using it for Nousmotards and decided to build an Ansible role for it to make it simpler to deploy.
Why did I built it as other projects like Kargo already exists? I just wanted a simple and maintainable role based on CoreOS official documentation. That&rsquo;s what I did:
 This role bootstrap a Kubernetes cluster based on CoreOS Container Linux for production usages.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2017/04/18/blog-migrated-to-hugo-on-github/">
                <h3 class="media-heading">Blog migrated to Hugo on Github</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">As you certainly seen, the blog has been migrated :-). Visualy there is a big change and technically it&rsquo;s the same.
I was fed up about maintaining Wordpress with its stack (Nginx / php-fpm / MariaDB) for a mostly static blog. I was thinking about migrating from Wordpress to something in markdown since several years but didn&rsquo;t know exactly which solution I wanted to choose. I really enjoyed using Wordpress but wanted to keep hands on my blog and didn&rsquo;t want to switch to full hosted Wordpress because of its limitations (image size etc&hellip;).</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2016/09/30/deploy-coreos-with-ansible/">
                <h3 class="media-heading">Deploy CoreOS with Ansible</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Sep 9, 2016
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">&nbsp;
CoreOS is a lightweight Linux operating system designed for clustered deployments providing automation, security, and scalability for your most critical applications.&nbsp;I&rsquo;ve been playing with CoreOS to replace Debian hosts which run Docker containers on Nousmotards project. CoreOS helps on simplifying bare metal deployment and avoid managing OS upgrade.
As I&rsquo;m still an Ansible lover, I&rsquo;ve made 2 roles:
 CoreOS Ansible:&nbsp;Ansible role to deploy pypy to CoreOS to be able to get Ansible prerequisites CoreOS: Ansible CoreOS role to deploy CoreOS on bare metal servers  If you want to quickly look at the result:</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2016/06/18/do-not-waste-time-with-grep-anymore-use-tag/">
                <h3 class="media-heading">Do not waste time with grep anymore, use tag</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2016
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Long time since my last post. This one is not very technical post, but it&rsquo;s a nice to have solution if you use grep usually. Are not you fed up to type vim  and search the line after a grep command ? If yes, this post is for you.
First of all, you may know that an alternative more user friendly to grep exist, called ag (perf comparison). I really like ag and grep, but something make me loose my time since several years and I&rsquo;m pretty sure it&rsquo;s your case too.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         840 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://blog.deimos.fr/images/fish_background.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://blog.deimos.fr/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>




  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/blog.deimos.fr\/2017\/08\/20\/kubernetes-with-traefik-and-lets-encrypt\/';
          
            this.page.identifier = '\/2017\/08\/20\/kubernetes-with-traefik-and-lets-encrypt'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'blog-deimosfr';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

