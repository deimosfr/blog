<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.69.2 with theme Tranquilpeak 0.4.8-BETA"><meta name=author content="Pierre Mavro / Deimosfr"><meta name=keywords content><meta name=description content="I recently been faced on a classical problem on InnoDB which is the fragmentation, but on Galera. InnoDB engine doesn&rsquo;t defragment on the fly and requires optimize maintenance sometimes to free disk space. But on Galera, which is a fault tolerance and high availability solution, it&rsquo;s a problem having tables locked by an optimize procedure. Until Galera doesn&rsquo;t support TokuDB and only fully support InnoDB, we had (with a colleague (Kevin aka Vinek)) to find a solution."><meta property="og:description" content="I recently been faced on a classical problem on InnoDB which is the fragmentation, but on Galera. InnoDB engine doesn&rsquo;t defragment on the fly and requires optimize maintenance sometimes to free disk space. But on Galera, which is a fault tolerance and high availability solution, it&rsquo;s a problem having tables locked by an optimize procedure. Until Galera doesn&rsquo;t support TokuDB and only fully support InnoDB, we had (with a colleague (Kevin aka Vinek)) to find a solution."><meta property="og:type" content="article"><meta property="og:title" content="Galera Innoptimizer: optimize tables without stress"><meta name=twitter:title content="Galera Innoptimizer: optimize tables without stress"><meta property="og:url" content="https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/"><meta property="twitter:url" content="https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/"><meta property="og:site_name" content="Deimosfr Blog"><meta property="og:description" content="I recently been faced on a classical problem on InnoDB which is the fragmentation, but on Galera. InnoDB engine doesn&rsquo;t defragment on the fly and requires optimize maintenance sometimes to free disk space. But on Galera, which is a fault tolerance and high availability solution, it&rsquo;s a problem having tables locked by an optimize procedure. Until Galera doesn&rsquo;t support TokuDB and only fully support InnoDB, we had (with a colleague (Kevin aka Vinek)) to find a solution."><meta name=twitter:description content="I recently been faced on a classical problem on InnoDB which is the fragmentation, but on Galera. InnoDB engine doesn&rsquo;t defragment on the fly and requires optimize maintenance sometimes to free disk space. But on Galera, which is a fault tolerance and high availability solution, it&rsquo;s a problem having tables locked by an optimize procedure. Until Galera doesn&rsquo;t support TokuDB and only fully support InnoDB, we had (with a colleague (Kevin aka Vinek)) to find a solution."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2014-09-30T10:00:13"><meta property="article:modified_time" content="2014-09-30T10:00:13"><meta property="article:section" content="Databases"><meta property="article:section" content="Debian"><meta property="article:section" content="Developement"><meta property="article:section" content="Hi-Tech"><meta property="article:section" content="Linux"><meta property="article:section" content="Red Hat"><meta property="article:section" content="SQL"><meta property="article:tag" content="galera"><meta property="article:tag" content="mariadb"><meta property="article:tag" content="mysql"><meta name=twitter:card content="summary"><meta name=twitter:site content="@deimosfr"><meta name=twitter:creator content="@deimosfr"><meta property="og:image" content="https://blog.deimos.fr/thumbnails/logo_galera.jpg"><meta property="twitter:image" content="https://blog.deimos.fr/thumbnails/logo_galera.jpg"><meta property="og:image" content="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640"><meta property="twitter:image" content="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640"><title>Galera Innoptimizer: optimize tables without stress</title><link rel=icon href=https://blog.deimos.fr/favicon.png><link rel=canonical href=https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin=anonymous><link rel=stylesheet href=https://blog.deimos.fr/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css><link rel=stylesheet href=https://blog.deimos.fr/css/custom.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-63927289-1','auto');ga('send','pageview');}</script></head><body><div id=blog><header id=header data-behavior=5><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=https://blog.deimos.fr/>Deimosfr Blog</a></div><a class=header-right-picture href=https://blog.deimos.fr/#about><img class=header-picture src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=90" alt="Author's picture"></a></header><nav id=sidebar data-behavior=5><div class=sidebar-container><div class=sidebar-profile><a href=https://blog.deimos.fr/#about><img class=sidebar-profile-picture src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author's picture"></a><h4 class=sidebar-profile-name>Pierre Mavro / Deimosfr</h4></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/><i class="sidebar-button-icon fa fa-lg fa-home"></i><span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/archives><i class="sidebar-button-icon fa fa-lg fa-archive"></i><span class=sidebar-button-desc>Archives</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/categories><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i><span class=sidebar-button-desc>Categories</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/tags><i class="sidebar-button-icon fa fa-lg fa-tags"></i><span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/index.xml><i class="sidebar-button-icon fa fa-lg fa-rss"></i><span class=sidebar-button-desc>RSS</span></a></li></ul><ul class=sidebar-buttons></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://www.deimos.fr target=_blank rel=noopener><i class="sidebar-button-icon fa fa-lg fa-user"></i><span class=sidebar-button-desc>About</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://wiki.deimos.fr target=_blank rel=noopener><i class="sidebar-button-icon fa fa-wikipedia-w"></i><span class=sidebar-button-desc>Wiki</span></a></li></ul></div></nav><div id=main data-behavior=5 class=hasCoverMetaIn><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class="post-header main-content-wrap text-left"><h1 class=post-title itemprop=headline>Galera Innoptimizer: optimize tables without stress</h1><div class="postShorten-meta post-meta"><time itemprop=datePublished datetime=2014-09-30T10:00:13Z>30 September 2014</time>
<span>in</span>
<a class=category-link href=https://blog.deimos.fr/categories/databases>Databases</a>,
<a class=category-link href=https://blog.deimos.fr/categories/debian>Debian</a>,
<a class=category-link href=https://blog.deimos.fr/categories/developement>Developement</a>,
<a class=category-link href=https://blog.deimos.fr/categories/hi-tech>Hi-Tech</a>,
<a class=category-link href=https://blog.deimos.fr/categories/linux>Linux</a>,
<a class=category-link href=https://blog.deimos.fr/categories/red-hat>Red Hat</a>,
<a class=category-link href=https://blog.deimos.fr/categories/sql>SQL</a></div></div><div class="post-content markdown" itemprop=articleBody><div class=main-content-wrap><p><img src=https://blog.deimos.fr/images/logo_galera.jpg alt=Galera-Cluster-logo>
I recently been faced on a classical problem on InnoDB which is the fragmentation, but on Galera. InnoDB engine doesn&rsquo;t defragment on the fly and requires optimize maintenance sometimes to free disk space. But on Galera, which is a fault tolerance and high availability solution, it&rsquo;s a problem having tables locked by an optimize procedure. Until Galera doesn&rsquo;t support TokuDB and only fully support InnoDB, we had (with a colleague (Kevin aka Vinek)) to find a solution. We found that changing RSU mode is the way to achieve it.</p><p>That&rsquo;s why <strong>I made a tool to help you to perform all the necessary actions to optimize tables in the most easy and secure way</strong>. Running an optimize on InnoDB tables in a Galera cluster will launch an optimize on every nodes. This is <strong>usually a big problem when using huge tables</strong>. This tool makes <strong>online InnoDB optimize on a Galera single node without tables lock feeling on the user side.</strong> But do not think this is magical as there is a counterpart: you have to reduce the write queries during that time or the optimize will fail with a &ldquo;dead lock&rdquo; error message.</p><p>Galera has an OSU mode called RSU which permit to perform online schema upgrades. This mode is used by Galera Innoptimizer to perform optimize on tables. The advantage of that solution is you can still perform write (and read of course) updates while running . It won&rsquo;t be replicated on any nodes, simply running locally.</p><p>Here is how it works:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=p>&amp;</span>gt<span class=p>;</span> ./ginnoptimizer.py -d all
<span class=o>[</span>+<span class=o>]</span> Trying to connect to MySQL/MariaDB instance...OK
<span class=o>[</span>+<span class=o>]</span> Getting all databases...OK
<span class=o>[</span>+<span class=o>]</span> Checking current Galera state... 
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_ready status...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_cluster status...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_connected status...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_desync status...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_OSU_method status...OK
<span class=o>[</span>+<span class=o>]</span> Getting list of all tables in database1 database...OK
<span class=o>[</span>+<span class=o>]</span> Enabling RSU mode...OK
<span class=o>[</span>+<span class=o>]</span> Starting optimization on database1 database... 
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_flow_control_paused status <span class=p>&amp;</span>gt<span class=p>;</span> 0.3...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> optimizing tablename in progress...OK
<span class=o>[</span>+<span class=o>]</span> Restoring TOI mode...OK
<span class=o>[</span>+<span class=o>]</span> Getting list of all tables in database2 database...OK
<span class=o>[</span>+<span class=o>]</span> Enabling RSU mode...OK
<span class=o>[</span>+<span class=o>]</span> Starting optimization on database2 database... 
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_flow_control_paused status <span class=p>&amp;</span>gt<span class=p>;</span> 0.3...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> optimizing tablename1 in progress...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> wsrep_flow_control_paused status <span class=p>&amp;</span>gt<span class=p>;</span> 0.3...OK
  -<span class=p>&amp;</span>gt<span class=p>;</span> optimizing tablename2 in progress...OK
<span class=o>[</span>+<span class=o>]</span> Restoring TOI mode...OK
Done !</code></pre></div><p>To know more about the solution and to get it, please <a href=https://github.com/deimosfr/galera_innoptimizer>follow the link of the project</a>.</p><p>Of course this is the first version, I&rsquo;d like to add more things like database exclude, table include/exclude, percentage of progression etc&mldr;Do not hesitate to give feedbacks on it :-)</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=https://blog.deimos.fr/tags/galera/>galera</a>
<a class="tag tag--primary tag--small" href=https://blog.deimos.fr/tags/mariadb/>mariadb</a>
<a class="tag tag--primary tag--small" href=https://blog.deimos.fr/tags/mysql/>mysql</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2014/10/02/sphinxdoc-and-readthedocs-theme-tricks-2/ data-tooltip="Sphinxdoc and ReadTheDocs theme tricks"><i class="fa fa-angle-left"></i><span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2014/09/28/netflix/ data-tooltip="Netflix: testing it and feedbacks"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/"><i class="fa fa-twitter"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#disqus_thread><i class="fa fa-comment-o"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-list"></i></a></li></ul></div><div id=disqus_thread><noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2021 Pierre Mavro / Deimosfr. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=5><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2014/10/02/sphinxdoc-and-readthedocs-theme-tricks-2/ data-tooltip="Sphinxdoc and ReadTheDocs theme tricks"><i class="fa fa-angle-left"></i><span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2014/09/28/netflix/ data-tooltip="Netflix: testing it and feedbacks"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2014/09/30/galera-innoptimizer-optimize-tables-without-stress/"><i class="fa fa-twitter"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#disqus_thread><i class="fa fa-comment-o"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-list"></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=5><i id=btn-close-shareoptions class="fa fa-close"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.deimos.fr%2F2014%2F09%2F30%2Fgalera-innoptimizer-optimize-tables-without-stress%2F"><i class="fa fa-facebook-official"></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fblog.deimos.fr%2F2014%2F09%2F30%2Fgalera-innoptimizer-optimize-tables-without-stress%2F"><i class="fa fa-twitter"></i><span>Share on Twitter</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-remove"></i></div><img id=about-card-picture src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author's picture"><h4 id=about-card-name>Pierre Mavro / Deimosfr</h4><div id=about-card-job><i class="fa fa-briefcase"></i><br>Qovery Co-Founder and CTO</div><div id=about-card-location><i class="fa fa-map-marker"></i><br>Paris - France</div></div></div><div id=cover style=background-image:url(https://blog.deimos.fr/images/fish_background.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin=anonymous></script><script src=https://blog.deimos.fr/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js></script><script src=https://blog.deimos.fr/js/custom.js></script><script lang=javascript>window.onload=updateMinWidth;window.onresize=updateMinWidth;document.getElementById("sidebar").addEventListener("transitionend",updateMinWidth);function updateMinWidth(){var sidebar=document.getElementById("sidebar");var main=document.getElementById("main");main.style.minWidth="";var w1=getComputedStyle(main).getPropertyValue("min-width");var w2=getComputedStyle(sidebar).getPropertyValue("width");var w3=getComputedStyle(sidebar).getPropertyValue("left");main.style.minWidth=`calc(${w1} - ${w2} - ${w3})`;}</script><script>$(document).ready(function(){hljs.configure({classPrefix:'',useBR:false});$('pre.code-highlight > code, pre > code').each(function(i,block){if(!$(this).hasClass('codeblock')){$(this).addClass('codeblock');}
hljs.highlightBlock(block);});});</script><script>var disqus_config=function(){this.page.url='https:\/\/blog.deimos.fr\/2014\/09\/30\/galera-innoptimizer-optimize-tables-without-stress\/';this.page.identifier='\/2014\/09\/30\/galera-innoptimizer-optimize-tables-without-stress\/'};(function(){if(window.location.hostname=="localhost"){return;}
var d=document,s=d.createElement('script');var disqus_shortname='blog-deimosfr';s.src='//'+disqus_shortname+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script></body></html>