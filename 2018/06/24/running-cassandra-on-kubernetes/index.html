<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.58.3 with theme Tranquilpeak 0.4.3-SNAPSHOT">
<meta name="author" content="Pierre Mavro / Deimosfr">
<meta name="keywords" content="">
<meta name="description" content="For my own company MySocialApp, I&rsquo;m managing multiple Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.">


<meta property="og:description" content="For my own company MySocialApp, I&rsquo;m managing multiple Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.">
<meta property="og:type" content="article">
<meta property="og:title" content="Running Cassandra in Kubernetes">
<meta name="twitter:title" content="Running Cassandra in Kubernetes">
<meta property="og:url" content="https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
<meta property="twitter:url" content="https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
<meta property="og:site_name" content="Deimosfr Blog">
<meta property="og:description" content="For my own company MySocialApp, I&rsquo;m managing multiple Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.">
<meta name="twitter:description" content="For my own company MySocialApp, I&rsquo;m managing multiple Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2018-07-16T00:00:00">
  
  
    <meta property="article:modified_time" content="2018-07-16T00:00:00">
  
  
  
    
      <meta property="article:section" content="Kubernetes">
    
      <meta property="article:section" content="Containers">
    
      <meta property="article:section" content="Cassandra">
    
      <meta property="article:section" content="Databases">
    
      <meta property="article:section" content="Distributed">
    
  
  
    
      <meta property="article:tag" content="Kubernetes">
    
      <meta property="article:tag" content="Containers">
    
      <meta property="article:tag" content="Cassandra">
    
      <meta property="article:tag" content="Databases">
    
      <meta property="article:tag" content="Distributed">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@deimosfr">


  <meta name="twitter:creator" content="@deimosfr">






  <meta property="og:image" content="https://blog.deimos.fr/thumbnails/logo_cassandra.png">
  <meta property="twitter:image" content="https://blog.deimos.fr/thumbnails/logo_cassandra.png">





  <meta property="og:image" content="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640">


    <title>Running Cassandra in Kubernetes</title>

    <link rel="icon" href="https://blog.deimos.fr/favicon.png">
    

    

    <link rel="canonical" href="https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://blog.deimos.fr/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://blog.deimos.fr/css/custom.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63927289-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://blog.deimos.fr/">Deimosfr Blog</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://blog.deimos.fr/#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://blog.deimos.fr/#about">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Pierre Mavro / Deimosfr</h4>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.deimos.fr" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-user"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://wiki.deimos.fr" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-wikipedia-w"></i>
      
      <span class="sidebar-button-desc">Wiki</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Running Cassandra in Kubernetes
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-07-16T00:00:00&#43;02:00">
        
  
  
  
  
    16 July 2018
  

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://blog.deimos.fr/categories/kubernetes">Kubernetes</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/containers">Containers</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/cassandra">Cassandra</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/databases">Databases</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/distributed">Distributed</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              

<p><img src="https://blog.deimos.fr/images/logo_cassandra.png" alt="Cassandra" /></p>

<p>For my own company <a href="https://mysocialapp.io/?ref=deimos_fr_running_cassandra_on_kubernetes" target="_blank">MySocialApp</a>, I&rsquo;m managing multiple <a href="http://cassandra.apache.org/" target="_blank">Cassandra</a> clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:</p>

<blockquote>
<p>The <a href="http://cassandra.apache.org/" target="_blank">Apache Cassandra</a> database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data. Cassandra&rsquo;s support for replicating across multiple datacenters is best-in-class, providing lower latency for your users and the peace of mind of knowing that you can survive regional outages.</p>
</blockquote>

<p>What does that mean having a Cassandra cluster in a Kubernetes on premise cluster? Here are the basics:</p>

<ul>
<li><strong>Data location</strong>: having data means, you should be able to know where they are located (physically, or should be able to access them in a known way). You can&rsquo;t run a Cassandra instance anywhere if you&rsquo;re not sure the data will be there and if you care about your data (of course).</li>
<li><strong>Performance</strong>: distributed storage on top of a distributed database is strongly discouraged if you&rsquo;re searching for the best performances.</li>
<li><strong>Observability</strong>: distributed solutions are generaly more complex to observe. The observability tooling around it must be good enough to easily troubleshot.</li>
<li><strong>Self management</strong>: having a Cassandra self managed solution on Kubernetes is a good idea, however managing all scenario cases on distributed systems is a very long and complex achievement.</li>
</ul>

<p>That&rsquo;s why in this blog post, you&rsquo;ll see how I made a <a href="https://github.com/MySocialApp/kubernetes-helm-chart-cassandra/" target="_blank">Cassandra helm chart</a>, what are the benefits based on my experience on Cassandra + Kubernetes and finally how it works.</p>

<h1 id="performances">Performances</h1>

<p>Cassandra require a local storage to get the best performances. That&rsquo;s why you should avoid using distributed storage and use a hostPath or <a href="https://kubernetes.io/docs/concepts/storage/volumes/" target="_blank">localstorage</a> configuration like:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">volumes<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>cassandra-data<span class="w">
</span><span class="w">    </span>hostPath<span class="p">:</span><span class="w">
</span><span class="w">      </span>path<span class="p">:</span><span class="w"> </span>/mnt/data/{{<span class="w"> </span>.Release.Namespace<span class="w"> </span>}}/cassandra</code></pre></div>

<p>More than that, Cassandra maanges by itself replication. Let&rsquo;s say you&rsquo;ve got a RF (Replication Factor) of 3, your data is available on 3 nodes. If you&rsquo;re using a distributed storage on top of Cassandra, it certainly also has a x3 RF. Which mean the same <strong>data is stored 9 times</strong>. That&rsquo;s a huge waste of space and money in addition of the performances.</p>

<p>Another thing, I&rsquo;ve added some default Cassandra options, however I recommend to update the Cassandra configuration settings according to your hardware and wishes:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">cassandraConfig<span class="p">:</span><span class="w">
</span><span class="w">  </span>concurrentWrites<span class="p">:</span><span class="w"> </span><span class="m">128</span><span class="w">
</span><span class="w">  </span>concurrentReads<span class="p">:</span><span class="w"> </span><span class="m">128</span><span class="w">
</span><span class="w">  </span>concurrentCompactors<span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span>batchSizeWarnThresholdInKb<span class="p">:</span><span class="w"> </span><span class="m">64</span><span class="w">
</span><span class="w">  </span>batchSizeFailThresholdInKb<span class="p">:</span><span class="w"> </span><span class="m">640</span><span class="w">
</span><span class="w">  </span>compactionThroughputMbPerSec<span class="p">:</span><span class="w"> </span><span class="m">150</span><span class="w">
</span><span class="w">  </span>heapNewSize<span class="p">:</span><span class="w"> </span>256M<span class="w">
</span><span class="w">  </span>hintedHandoffThrottleInKb<span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span><span class="w">  </span>maxHeap<span class="p">:</span><span class="w"> </span>4G<span class="w">
</span><span class="w">  </span>maxHintsDeliveryThreads<span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">  </span>memtableAllocationType<span class="p">:</span><span class="w"> </span><span class="s2">&#34;offheap_objects&#34;</span><span class="w">
</span><span class="w">  </span>memtableFlushWriter<span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">  </span>memtableCleanupThreshold<span class="p">:</span><span class="w"> </span><span class="m">0.2</span><span class="w">
</span><span class="w">  </span>rowCacheSizeInMb<span class="p">:</span><span class="w"> </span><span class="m">128</span><span class="w">
</span><span class="w">  </span>rowCacheSavePeriod<span class="p">:</span><span class="w"> </span><span class="m">14400</span></code></pre></div>

<p>To reduce performance issues as well and reduce cluster failure in case of an issue, I should <strong>avoid getting multiple instances on the same physocal host</strong>. For that I&rsquo;m using <code>podAntiAffinity</code>:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">affinity<span class="p">:</span><span class="w">
</span><span class="w">  </span>podAntiAffinity<span class="p">:</span><span class="w">
</span><span class="w">    </span>requiredDuringSchedulingIgnoredDuringExecution<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>labelSelector<span class="p">:</span><span class="w">
</span><span class="w">        </span>matchExpressions<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>key<span class="p">:</span><span class="w"> </span>app<span class="w">
</span><span class="w">          </span>operator<span class="p">:</span><span class="w"> </span>In<span class="w">
</span><span class="w">          </span>values<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>{{<span class="w"> </span>template<span class="w"> </span><span class="s2">&#34;kubernetes.name&#34;</span><span class="w"> </span>.<span class="w"> </span>}}<span class="w">
</span><span class="w">      </span>topologyKey<span class="p">:</span><span class="w"> </span>kubernetes.io/hostname</code></pre></div>

<p>You can also tune the JVM memory allocation and parameters to optimize memory usage in a container.</p>

<h1 id="statefulset-self-management">Statefulset &amp; self management</h1>

<h2 id="statefulset">Statefulset</h2>

<p>On this <a href="https://github.com/MySocialApp/kubernetes-helm-chart-cassandra/" target="_blank">Cassandra helm chart</a>, I decided to use <code>Statefulset</code> because:</p>

<ul>
<li>It understands the complexity of most of the stateful applications and have a the corresponding behavior</li>
<li>The given naming convention is simple to follow: <code>cassandra-X</code></li>
<li>Coupled with a <code>PodDisruptionBudget</code>, it brings a safetier solution</li>
<li>With postStart and preStop hooks, I&rsquo;m able to define the tasks I want to address to the Cassandra cluster</li>
</ul>

<h2 id="upgrade-stategy">Upgrade stategy</h2>

<p>Regarding the rollout and <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#update-strategies" target="_blank">rolling upgrade/restart strategy</a>, it&rsquo;s really simple with this kind of rules on a Statefulset, I&rsquo;m sure the procedure won&rsquo;t go too fast:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">updateStrategy<span class="p">:</span><span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span><span class="s2">&#34;RollingUpdate&#34;</span></code></pre></div>

<h2 id="pod-disruption-budget">Pod disruption budget</h2>

<p>Using the <code>PodDisruptionBudget</code>, I&rsquo;m also sure I won&rsquo;t have more than 1 (the default) planned node down in my cluster. With a RF of 3, I know I can loose a node during a rolling restart:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">maxUnavailable<span class="p">:</span><span class="w"> </span>{{<span class="w"> </span>.Values.cassandraMaxUnavailableNodes<span class="w"> </span>}}<span class="w">
</span><span class="w"></span>selector<span class="p">:</span><span class="w">
</span><span class="w">  </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>{{<span class="w"> </span>template<span class="w"> </span><span class="s2">&#34;kubernetes.name&#34;</span><span class="w"> </span>.<span class="w"> </span>}}</code></pre></div>

<h2 id="run-override">Run override</h2>

<p>I also added an override script to replace run.sh for several reasons:</p>

<ul>
<li><strong>Prerequisites</strong>: I wanted to set some global variables first requiring shell and pipes stuffs.</li>
<li><strong>Flexibility</strong>: it makes possible to add specific command before the instance start. This could be very be useful if you need to run at a given time some commands, but can&rsquo;t rolling restart the whole cluster. This already saved my life twice.</li>
</ul>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nb">source</span> /usr/local/apache-cassandra/scripts/envVars.sh
/usr/local/apache-cassandra/scripts/jvm_options.sh

/run.sh</code></pre></div>

<h2 id="post-start-hook">Post start hook</h2>

<p>In the pre start hook:</p>

<ul>
<li>I&rsquo;m ensuring the service is up and running</li>
<li>I&rsquo;m registering the cluster to <a href="http://cassandra-reaper.io" target="_blank">Cassandra reaper</a> if not already done (will talk later about Cassandra Reaper)</li>
</ul>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nb">source</span> /usr/local/apache-cassandra/scripts/envVars.sh

<span class="k">until</span> /ready-probe.sh <span class="p">;</span> <span class="k">do</span>
  <span class="nb">echo</span> <span class="s2">&#34;Waiting node to be ready&#34;</span>
  sleep <span class="m">1</span>
<span class="k">done</span>

<span class="o">{{</span>- <span class="k">if</span> .Values.cassandraReaper.enabled <span class="o">}}</span>
<span class="c1"># Wait until replicas is 3 to ready Cassandra Reaper database</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s1">&#39;cassandra-2&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  cqlsh -e <span class="s2">&#34;CREATE KEYSPACE IF NOT EXISTS reaper_db WITH replication = {&#39;class&#39;: &#39;NetworkTopologyStrategy&#39;, &#39;{{ .Values.cassandraDC }}&#39;: 3};&#34;</span> &gt; /var/log/reaperdb.log
<span class="k">fi</span>
<span class="o">{{</span>- end <span class="o">}}</span>

<span class="o">{{</span>- <span class="k">if</span> .Values.cassandraReaperRegister.enableReaperRegister <span class="o">}}</span>
<span class="c1"># Register cluster into Cassandra Reaper</span>
<span class="c1"># Do not target current instance to avoid unready instance status (and registration failure)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s1">&#39;cassandra-0&#39;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="nv">seedHost</span><span class="o">=</span><span class="k">$(</span>hostname -A <span class="p">|</span> sed <span class="s1">&#39;s/^cassandra-0/cassandra-1/&#39;</span><span class="k">)</span>
<span class="k">else</span>
  <span class="nv">seedHost</span><span class="o">=</span><span class="k">$(</span>hostname -A <span class="p">|</span> sed -r <span class="s1">&#39;s/^cassandra-\w+(\..+)/cassandra-0\1/&#39;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="c1"># Check if cluster needs to be registred or simply updated</span>
<span class="nv">counter</span><span class="o">=</span><span class="m">0</span>
<span class="k">if</span> <span class="o">[</span> <span class="k">$(</span>curl -s <span class="s2">&#34;http://{{ .Values.cassandraReaperRegister.reaperServerServiceName }}/cluster&#34;</span> <span class="p">|</span> grep -c <span class="nv">$CASSANDRA_CLUSTER_NAME</span><span class="k">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="k">while</span> <span class="o">[</span> <span class="k">$(</span>curl -s -I -X POST <span class="s2">&#34;http://{{ .Values.cassandraReaperRegister.reaperServerServiceName }}/cluster?seedHost=</span><span class="nv">$seedHost</span><span class="s2">&#34;</span> <span class="p">|</span> grep -c <span class="s2">&#34;^HTTP/1.1 201 Created&#34;</span><span class="k">)</span> !<span class="o">=</span> <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$counter</span> <span class="o">==</span> <span class="m">5</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nb">break</span>
    <span class="k">fi</span>
    <span class="nv">counter</span><span class="o">=</span><span class="k">$((</span>counter+1<span class="k">))</span>
    sleep <span class="m">5</span>
  <span class="k">done</span>
<span class="k">else</span>
  <span class="k">while</span> <span class="o">[</span> <span class="k">$(</span>curl -s -I -X PUT <span class="s2">&#34;http://{{ .Values.cassandraReaperRegister.reaperServerServiceName }}/cluster/</span><span class="si">${</span><span class="nv">CASSANDRA_CLUSTER_NAME</span><span class="si">}</span><span class="s2">?seedHost=</span><span class="nv">$seedHost</span><span class="s2">&#34;</span> <span class="p">|</span> egrep -c <span class="s2">&#34;^HTTP/1.1 (200|304)&#34;</span><span class="k">)</span> !<span class="o">=</span> <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$counter</span> <span class="o">==</span> <span class="m">5</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="nb">break</span>
    <span class="k">fi</span>
    <span class="nv">counter</span><span class="o">=</span><span class="k">$((</span>counter+1<span class="k">))</span>
    sleep <span class="m">5</span>
  <span class="k">done</span>
<span class="k">fi</span>
<span class="o">{{</span>- end <span class="o">}}</span>
<span class="nb">exit</span> <span class="m">0</span></code></pre></div>

<h2 id="pre-stop-hook">Pre stop hook</h2>

<p>In the pre stop hook:</p>

<ul>
<li>I&rsquo;m ensure the correct health of the cluster before requesting node leave. This to avoid a total blackout</li>
<li>I&rsquo;m ensuring the node stops properly</li>
</ul>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
run_nodetool<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&#34;Running: nodetool </span><span class="nv">$1</span><span class="s2">&#34;</span>
  /usr/local/apache-cassandra/bin/nodetool <span class="nv">$1</span>
  sleep <span class="m">5</span>
<span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> <span class="k">$(</span>/usr/local/apache-cassandra/bin/nodetool status <span class="p">|</span> awk <span class="s2">&#34;/</span><span class="nv">$CASSANDRA_RACK</span><span class="s2">/{ print \$1,\$2 }&#34;</span> <span class="p">|</span> grep -v <span class="nv">$POD_IP</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span> <span class="p">|</span> grep -v UN<span class="k">)</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do</span>
  <span class="nb">echo</span> <span class="s2">&#34;Waiting all nodes to recover a correct status before draining this node&#34;</span>
  sleep <span class="m">5</span>
  pidof java <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span>
<span class="k">done</span>

run_nodetool disablethrift
run_nodetool disablebinary
run_nodetool disablegossip
run_nodetool flush
run_nodetool drain
sleep <span class="m">10</span>
run_nodetool stop
run_nodetool stopdaemon

<span class="nb">exit</span> <span class="m">0</span></code></pre></div>

<h1 id="observability">Observability</h1>

<p>Observing a Cassandra cluster may not be an easy task. There are plenty of metrics per nodes which can confuse the beginners. That&rsquo;s why providing an exporter with a pre-made Grafana dashboard is a good solution for everyone.</p>

<h2 id="cassandra-exporter">Cassandra exporter</h2>

<p>To make it simple, I&rsquo;m using the Prometheus format (as it becomes the standard now) and I&rsquo;m using <a href="https://github.com/criteo/cassandra_exporter" target="_blank">Cassandra Exporter</a> (made by my NoSQL team at <a href="https://www.criteo.com" target="_blank">Criteo</a>).</p>

<p>On each nodes it will deploy an exporter (an additional container in the Cassandra pod):</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Cassandra Exporter</span><span class="w">
</span><span class="w"></span>cassandraExporter<span class="p">:</span><span class="w">
</span><span class="w">  </span>enableExporter<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span>replicaCount<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>imageVersion<span class="p">:</span><span class="w"> </span><span class="m">1.0.2</span><span class="w">
</span><span class="w">  </span>nodeSelector<span class="p">:</span><span class="w">
</span><span class="w">    </span>node-role.kubernetes.io/node<span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span>resources<span class="p">:</span><span class="w">
</span><span class="w">    </span>limits<span class="p">:</span><span class="w">
</span><span class="w">      </span>cpu<span class="p">:</span><span class="w"> </span>300m<span class="w">
</span><span class="w">      </span>memory<span class="p">:</span><span class="w"> </span>500Mi<span class="w">
</span><span class="w">    </span>requests<span class="p">:</span><span class="w">
</span><span class="w">      </span>cpu<span class="p">:</span><span class="w"> </span>300m<span class="w">
</span><span class="w">      </span>memory<span class="p">:</span><span class="w"> </span>500Mi<span class="w">
</span><span class="w">  </span>config<span class="p">:</span><span class="w">
</span><span class="w">    </span>host<span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">7199</span><span class="w">
</span><span class="w">    </span>listenPort<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span>jvmOpts<span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Prometheus scraping</span><span class="w">
</span><span class="w"></span>cassandraPrometheusScrap<span class="p">:</span><span class="w">
</span><span class="w">  </span>enableScrap<span class="p">:</span><span class="w"> </span><span class="kc">false</span></code></pre></div>

<p>If you&rsquo;re using <a href="https://github.com/coreos/prometheus-operator" target="_blank">Prometheus Operator</a>, you can enable automatic scraping here (mean that Prometheus server will automatically retrieve information from exporter).</p>

<h2 id="grafana">Grafana</h2>

<p>A Cassandra dashboard compatible with Kubernetes is also available <a href="https://grafana.com/dashboards/6258" target="_blank">here</a>.</p>

<p><img src="https://blog.deimos.fr/images/cassandra_grafana.png" alt="CassandraDashboard" /></p>

<p>You only have to import it in your Grafana interface.</p>

<h2 id="alerting">Alerting</h2>

<p>Once again, if you&rsquo;re using <a href="https://github.com/coreos/prometheus-operator" target="_blank">Prometheus Operator</a>, you can enable basic alerting rules with Alert Manager:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">cassandraAlertmanager<span class="p">:</span><span class="w">
</span><span class="w">  </span>enableAlerts<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>alertLabels<span class="p">:</span><span class="w">
</span><span class="w">    </span>sloInterrupt<span class="p">:</span><span class="w">
</span><span class="w">      </span>serviceLevel<span class="p">:</span><span class="w"> </span>objective<span class="w">
</span><span class="w">      </span>severity<span class="p">:</span><span class="w"> </span>interrupt<span class="w">
</span><span class="w">      </span>team<span class="p">:</span><span class="w"> </span>infra<span class="w">
</span><span class="w">      </span>type<span class="p">:</span><span class="w"> </span>functional<span class="w">
</span><span class="w">    </span>sloPage<span class="p">:</span><span class="w">
</span><span class="w">      </span>serviceLevel<span class="p">:</span><span class="w"> </span>objective<span class="w">
</span><span class="w">      </span>severity<span class="p">:</span><span class="w"> </span>page<span class="w">
</span><span class="w">      </span>team<span class="p">:</span><span class="w"> </span>infra<span class="w">
</span><span class="w">      </span>type<span class="p">:</span><span class="w"> </span>functional</code></pre></div>

<h1 id="maintenance-and-operations">Maintenance and operations</h1>

<p>On Cassandra, there are 2 others important actions:</p>

<ul>
<li><strong>Backups</strong>: as usual, it&rsquo;s always preferable to get backups (just in case)</li>
<li><strong>Repair</strong>: repair tables to ensure consistency</li>
</ul>

<h2 id="backups-restore">Backups / Restore</h2>

<p>Backuping Cassandra is not so trivial. That&rsquo;s why I&rsquo;ve made some scripts included in the helm chart <strong>ready to plan backups and help on restore</strong>.</p>

<p><strong>The backups scripts are made to store on AWS S3</strong>. A cronjob exist for it, you simple have to set the &ldquo;cassandraBackup&rdquo; parameters.</p>

<h3 id="enbale-backups">Enbale backups</h3>

<p>To enable backups, you simply have to update this section with your options. A Cron job will be created to perform backups of all nodes at the same time (for consistency purpose):</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">cassandraBackup<span class="p">:</span><span class="w">
</span><span class="w">  </span>enableBackups<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>backupSchedule<span class="p">:</span><span class="w"> </span><span class="s2">&#34;0 3 * * *&#34;</span><span class="w">
</span><span class="w">  </span>backupImageVersion<span class="p">:</span><span class="w"> </span>v0<span class="m">.1</span><span class="w">
</span><span class="w">  </span>awsAccessKeyId<span class="p">:</span><span class="w"> </span><span class="s2">&#34;xxx&#34;</span><span class="w">
</span><span class="w">  </span>awsSecretAccessKey<span class="p">:</span><span class="w"> </span><span class="s2">&#34;yyy&#34;</span><span class="w">
</span><span class="w">  </span>awsPassphrase<span class="p">:</span><span class="w"> </span><span class="s2">&#34;zzz&#34;</span><span class="w">
</span><span class="w">  </span>awsBucket<span class="p">:</span><span class="w"> </span><span class="s2">&#34;bucket_name&#34;</span><span class="w">
</span><span class="w">  </span><span class="c">#duplicityOptions: &#34;--archive-dir /var/lib/cassandra/.duplicity --allow-source-mismatch --s3-european-buckets --s3-use-new-style --copy-links --num-retries 3 --s3-use-multiprocessing --s3-multipart-chunk-size 100 --volsize 1024 full . s3://s3.amazonaws.com/cassandra-backups/$CLUSTER_DOMAIN/$CASSANDRA_CLUSTER_NAME/$(hostname)&#34;</span><span class="w">
</span><span class="w">  </span>awsDestinationPath<span class="p">:</span><span class="w"> </span><span class="s2">&#34;s3://s3-eu-west-1.amazonaws.com/${AWS_BUCKET}/$CLUSTER_DOMAIN/$CASSANDRA_CLUSTER_NAME/$(hostname)&#34;</span><span class="w">
</span><span class="w">  </span>restoreFolder<span class="p">:</span><span class="w"> </span><span class="s2">&#34;/var/lib/cassandra/restore&#34;</span></code></pre></div>

<h3 id="list">List</h3>

<p>To list backups for a statefulset instance, connect to an instance like in this example and call the script:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">kubectl <span class="nb">exec</span> -it cassandra-0 bash
/usr/local/apache-cassandra/scripts/snapshot2s3.sh list &lt;AWS_ACCESS_KEY_ID&gt; &lt;AWS_SECRET_ACCESS_KEY&gt; &lt;AWS_PASSPHRASE&gt; &lt;AWS_BUCKET&gt;</code></pre></div>

<p>Replace all AWS information with the corresponding ones.</p>

<h3 id="restore">Restore</h3>

<p>To restore backups, configure properly the &ldquo;restoreFolder&rdquo; var and run this command:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">kubectl <span class="nb">exec</span> -it cassandra-0 bash
/usr/local/apache-cassandra/scripts/snapshot2s3.sh restore &lt;AWS_ACCESS_KEY_ID&gt; &lt;AWS_SECRET_ACCESS_KEY&gt; &lt;AWS_PASSPHRASE&gt; &lt;AWS_BUCKET&gt; &lt;RESTORE_TIME&gt;</code></pre></div>

<p>RESTORE_TIME should be used as described in the <a href="http://duplicity.nongnu.org/duplicity.1.html#sect8" target="_blank">Duplicity manual Time Format section</a>.
For example (3D to restore the the last 3 days backup)</p>

<p>You can then use the script cassandra-restore.sh to restore a desired keyspace with all or one table:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">/usr/local/apache-cassandra/scripts/cassandra-restore.sh /var/lib/cassandra/restore/var/lib/cassandra/data <span class="o">[</span>keyspace<span class="o">]</span></code></pre></div>

<p>Try to use help if you need more info about it.</p>

<h2 id="repair-tables">Repair tables</h2>

<p>Repairing tables may be painfull sometimes. Hopefully <a href="http://cassandra-reaper.io" target="_blank">Cassandra Reaper</a> helps to avoid managing it manually.</p>

<p>You can deploy a server instance (require a Cassandra backend):</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">cassandraReaper<span class="p">:</span><span class="w">
</span><span class="w">  </span>enableReaper<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>replicaCount<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>imageVersion<span class="p">:</span><span class="w"> </span><span class="m">1.1.0</span><span class="w">
</span><span class="w">  </span>nodeSelector<span class="p">:</span><span class="w">
</span><span class="w">    </span>node-role.kubernetes.io/node<span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span>contactPoints<span class="p">:</span><span class="w"> </span>cassandra<span class="m">-0.</span>cassandra<span class="w">
</span><span class="w">  </span>jmxAuth<span class="p">:</span><span class="w">
</span><span class="w">    </span>username<span class="p">:</span><span class="w"> </span>reaperUser<span class="w">
</span><span class="w">    </span>password<span class="p">:</span><span class="w"> </span>reaperPass<span class="w">
</span><span class="w">  </span><span class="c"># clusterName:</span><span class="w">
</span><span class="w">  </span><span class="c"># keyspace: reaper_db</span><span class="w">
</span><span class="w">  </span>envVariables<span class="p">:</span><span class="w">
</span><span class="w">    </span>JAVA_OPTS<span class="p">:</span><span class="w"> </span><span class="s2">&#34;-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2 -XX:+AlwaysPreTouch&#34;</span><span class="w">
</span><span class="w">    </span>REAPER_CASS_KEYSPACE<span class="p">:</span><span class="w"> </span>reaper_db<span class="w">
</span><span class="w">    </span>REAPER_REPAIR_PARALELLISM<span class="p">:</span><span class="w"> </span>DATACENTER_AWARE<span class="w">
</span><span class="w">    </span>REAPER_REPAIR_INTENSITY<span class="p">:</span><span class="w"> </span><span class="m">0.5</span><span class="w">
</span><span class="w">    </span>REAPER_AUTO_SCHEDULING_ENABLED<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span>REAPER_SCHEDULE_DAYS_BETWEEN<span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span>REAPER_REPAIR_RUN_THREADS<span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">
</span><span class="w">    </span>REAPER_HANGING_REPAIR_TIMEOUT_MINS<span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">    </span>REAPER_REPAIR_MANAGER_SCHEDULING_INTERVAL_SECONDS<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span>REAPER_SEGMENT_COUNT<span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span><span class="w">    </span>REAPER_LOGGING_ROOT_LEVEL<span class="p">:</span><span class="w"> </span>INFO<span class="w">
</span><span class="w">    </span>REAPER_SERVER_ADMIN_PORT<span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span><span class="w">    </span>REAPER_SERVER_APP_PORT<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span>REAPER_METRICS_ENABLED<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>resources<span class="p">:</span><span class="w">
</span><span class="w">    </span>limits<span class="p">:</span><span class="w">
</span><span class="w">      </span>cpu<span class="p">:</span><span class="w"> </span>500m<span class="w">
</span><span class="w">      </span>memory<span class="p">:</span><span class="w"> </span>500Mi<span class="w">
</span><span class="w">    </span>requests<span class="p">:</span><span class="w">
</span><span class="w">      </span>cpu<span class="p">:</span><span class="w"> </span>500m<span class="w">
</span><span class="w">      </span>memory<span class="p">:</span><span class="w"> </span>500Mi</code></pre></div>

<p>And then you simply have enable client registration to get all your nodes and cluster automatically added into Cassandra Reaper:</p>

<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">cassandraReaperRegister<span class="p">:</span><span class="w">
</span><span class="w">  </span>enableReaperRegister<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>reaperServerServiceName<span class="p">:</span><span class="w"> </span>cassandra-reaper.svc</code></pre></div>

<p>Finally you&rsquo;ll find the reaper interface available:</p>

<p><img src="https://blog.deimos.fr/images/cassandra_reaper.jpg" alt="CassandraReaper" /></p>

<h1 id="conclusion">Conclusion</h1>

<p>This <a href="https://github.com/MySocialApp/kubernetes-helm-chart-cassandra/" target="_blank">Cassandra helm chart</a> is helping me day to day. It gives a lot of autonomy to my cluster, gives me the possibility to switch to fallback to a manual way to manage specific Cassandra cases, gives enough automation to avoid spending too many time on managing my Cassandra clusters. I&rsquo;m pretty well satisfied of this solution.</p>

<p>Some of you may think an Operator would be preferable, that&rsquo;s true. However in nowdays, there is no stable enough Operator managing Cassandra. Writing one takes some time and I unfortunately do not get this time today (but be happy to participate if a serious initiative is driven) and getting one ready to handle every situations will require a ton of tests and time.</p>

<p>So feel free to participate and I hope you&rsquo;ll enjoy it :)</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/kubernetes/">Kubernetes</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/containers/">Containers</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/cassandra/">Cassandra</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/databases/">Databases</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/distributed/">Distributed</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2018/10/11/converting-raw-to-jpg-with-nice-rendering/" data-tooltip="Converting RAW to JPG with nice rendering">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2018/01/31/integrate-gcr-in-your-on-premise-kubernetes/" data-tooltip="Integrate GCR in your on premise k8s cluster">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 Pierre Mavro / Deimosfr. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2018/10/11/converting-raw-to-jpg-with-nice-rendering/" data-tooltip="Converting RAW to JPG with nice rendering">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2018/01/31/integrate-gcr-in-your-on-premise-kubernetes/" data-tooltip="Integrate GCR in your on premise k8s cluster">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.deimos.fr%2F2018%2F06%2F24%2Frunning-cassandra-on-kubernetes%2F">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fblog.deimos.fr%2F2018%2F06%2F24%2Frunning-cassandra-on-kubernetes%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Pierre Mavro / Deimosfr</h4>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Qovery Co-Founder and CTO
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Paris - France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2019/02/08/k8s-euft-run-functional-tests-on-your-helm-charts/">
                <h3 class="media-heading">k8s-euft: run functional tests on your Helm charts</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Feb 2, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">I&rsquo;m managing applications inside Kubernetes for more than 2 years for MySocialApp a social news feed solution and recently Referlab, an impressive referral marketing solution. If you follow me, you certainly know that I&rsquo;ve made multiple Helm charts on distributed technologies like:
 Cassandra Helm chart Elasticsearch Helm chart Traefik Helm chart  After several years of experience on it, you can trust me when I say managing statefulset on Kubernetes is not the easiest thing to do.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/12/19/running-docker-for-your-home-server/">
                <h3 class="media-heading">Running Docker for your home server</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Since several years, I&rsquo;m hosting a lot of things: blog, wiki, emails etc&hellip; I&rsquo;ve played with Vserver, OpenVZ, KVM and finaly LXC. For years, I&rsquo;ve learned how to use all of them but the most known solution during the last years is Docker.
I even can remeber the first Meetup I&rsquo;ve attended in Paris talking about Docker 5 years ago. Now containers are eveverywhere. I recently changed the server I&rsquo;m running for my own usage and this was the good timing to switch from LXC to Docker.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/11/20/wireguard-on-debian-and-edgerouter/">
                <h3 class="media-heading">WireGuard on Debian and EdgeRouter</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">WireGuard is a very good alternative to OpenVPN. I&rsquo;ve been using OpenVPN for more than 10 years now and I was happy until I understood how slow it can be on low energy devices like EdgeRouter.
To give you an idea, on my Fiber Home connection (200Mbps), I&rsquo;m limited to 18Mbps. With OpenVPN, I&rsquo;m reaching the maximum CPU usage on the EdgeRouter. I&rsquo;ve heard of WireGuard about a year now and it was time for me to test this interresting alternative.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/11/19/restore-edgerouter-usb-drive/">
                <h3 class="media-heading">Restore EdgeRouter USB drive</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">I&rsquo;ve a Ubiquiti EdgeRouter PoE since several years now and really like it. Fanless, small, running on Debian (unfortunately not really up to date) and powerful.
However I recently had issues with the disk. Simply dead and obviously a reboot didn&rsquo;t repaired it. I&rsquo;ve been searching solutions on the official forum to replace the disk and I was surprised about the fact it runs on a simple USB stick. I decided to replace it with a Kingston one:</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/10/11/bye-bye-mediawiki/">
                <h3 class="media-heading">Bye bye Mediawiki</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">After more than 10 years using my beloved Mediawiki (wiki.deimos.fr), I decided to convert it into static html files and stop using Mediawiki :(.
Why? Because maintaining a Mediawiki is a pain when you&rsquo;re using a lot of extensions. In addition, I&rsquo;m not using Mediawiki anymore at work, not really following the evolution, don&rsquo;t want to keep maintaining php/mariadb/nginx and upgrading Mediawiki configuration can be complex as well.
I really love markdown solutions generating static files like Hugo and I already did it whith my previous Wordpress.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/10/11/converting-raw-to-jpg-with-nice-rendering/">
                <h3 class="media-heading">Converting RAW to JPG with nice rendering</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Oct 10, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">I&rsquo;m an amateur photographer and I&rsquo;m using an Olympus E-M1 Mark II camera. I take photos in RAW mode to be able. For those who know me, my computer is running on Linux and I&rsquo;m using Geeqie to display RAW picture. It&rsquo;s a very fast and powerful solution to display them.
In addition of displaying them quickly, it enhances the look and I really appreciate the rendering. Here is the original image (the first one) and the redered one by Geeqie (the second one):</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
                <h3 class="media-heading">Running Cassandra in Kubernetes</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">For my own company MySocialApp, I&rsquo;m managing multiple Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/31/integrate-gcr-in-your-on-premise-kubernetes/">
                <h3 class="media-heading">Integrate GCR in your on premise k8s cluster</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">I&rsquo;m using Kubernetes on an on premise cluster for MySocialApp. Today, I&rsquo;m storing MySocialApp public images at Quay.io and I also wanted to store private images. I didn&rsquo;t want to bootstrap a private registry for it to avoid maintaining it, having a distributed storage to maintain for it etc&hellip;but wanted a solution at a lower cost.
I started to look at DockerHub and Quay.io. As far aas I saw, DockerHub do not provide private registry while Quay does.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/26/install-jeedom-on-synology-with-docker/">
                <h3 class="media-heading">Install Jeedom on Synology with Docker</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">The Jeedom software is open source; you have complete access to the software that manages your home automation. Jeedom is compatible with various protocols, like Z-Wave, RFXCOM, RTS SOMFY, EnOcean, xPL, etc.
Installing Jeedom on Synology with Docker it not a complex task. However for those who are not familiar with those technologies, I summarized here the installation process for a Z-wave network.
First of all, let&rsquo;s look at the requirements:</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/23/traefik-ha-helm-chart-with-le-on-k8s/">
                <h3 class="media-heading">Traefik HA Helm chart with Let&#39;s Encrypt on Kubernetes</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
In a previous post, I explained how to manually deploy it in HA mode. For MySocialApp (iOS and Android social app builder - SaaS), I had to automate it.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         846 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://blog.deimos.fr/images/fish_background.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://blog.deimos.fr/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


  
    <script src="https://blog.deimos.fr/js/custom.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/blog.deimos.fr\/2018\/06\/24\/running-cassandra-on-kubernetes\/';
          
            this.page.identifier = '\/2018\/06\/24\/running-cassandra-on-kubernetes\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'blog-deimosfr';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

