<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.69.2 with theme Tranquilpeak 0.4.7-BETA"><meta name=author content="Pierre Mavro / Deimosfr"><meta name=keywords content><meta name=description content="In my previous post, I talked about how to speed up reads and writes coupling Redis with Neo4J. Now I want to share with you how it&rsquo;s possible to unload your server and use Elasticsearch to speed up news feed and user wall.
1/ Show me your news feed A news feed is the main page of traditional social networks. Its main goal is to show you all recents updates from your friends and your interests."><meta property="og:description" content="In my previous post, I talked about how to speed up reads and writes coupling Redis with Neo4J. Now I want to share with you how it&rsquo;s possible to unload your server and use Elasticsearch to speed up news feed and user wall.
1/ Show me your news feed A news feed is the main page of traditional social networks. Its main goal is to show you all recents updates from your friends and your interests."><meta property="og:type" content="article"><meta property="og:title" content="Elasticsearch: How we speed up news feeds and user walls display"><meta name=twitter:title content="Elasticsearch: How we speed up news feeds and user walls display"><meta property="og:url" content="https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/"><meta property="twitter:url" content="https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/"><meta property="og:site_name" content="Deimosfr Blog"><meta property="og:description" content="In my previous post, I talked about how to speed up reads and writes coupling Redis with Neo4J. Now I want to share with you how it&rsquo;s possible to unload your server and use Elasticsearch to speed up news feed and user wall.
1/ Show me your news feed A news feed is the main page of traditional social networks. Its main goal is to show you all recents updates from your friends and your interests."><meta name=twitter:description content="In my previous post, I talked about how to speed up reads and writes coupling Redis with Neo4J. Now I want to share with you how it&rsquo;s possible to unload your server and use Elasticsearch to speed up news feed and user wall.
1/ Show me your news feed A news feed is the main page of traditional social networks. Its main goal is to show you all recents updates from your friends and your interests."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2016-01-20T10:00:41"><meta property="article:modified_time" content="2016-01-20T10:00:41"><meta property="article:section" content="Developement"><meta property="article:section" content="Nousmotards"><meta property="article:tag" content="nousmotards"><meta name=twitter:card content="summary"><meta name=twitter:site content="@deimosfr"><meta name=twitter:creator content="@deimosfr"><meta property="og:image" content="https://blog.deimos.fr/thumbnails/logo_elasticsearch.png"><meta property="twitter:image" content="https://blog.deimos.fr/thumbnails/logo_elasticsearch.png"><meta property="og:image" content="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640"><meta property="twitter:image" content="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640"><title>Elasticsearch: How we speed up news feeds and user walls display</title><link rel=icon href=https://blog.deimos.fr/favicon.png><link rel=canonical href=https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin=anonymous><link rel=stylesheet href=https://blog.deimos.fr/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css><link rel=stylesheet href=https://blog.deimos.fr/css/custom.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-63927289-1','auto');ga('send','pageview');}</script></head><body><div id=blog><header id=header data-behavior=5><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=https://blog.deimos.fr/>Deimosfr Blog</a></div><a class=header-right-picture href=https://blog.deimos.fr/#about><img class=header-picture src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=90" alt="Author's picture"></a></header><nav id=sidebar data-behavior=5><div class=sidebar-container><div class=sidebar-profile><a href=https://blog.deimos.fr/#about><img class=sidebar-profile-picture src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author's picture"></a><h4 class=sidebar-profile-name>Pierre Mavro / Deimosfr</h4></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/><i class="sidebar-button-icon fa fa-lg fa-home"></i><span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/archives><i class="sidebar-button-icon fa fa-lg fa-archive"></i><span class=sidebar-button-desc>Archives</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/categories><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i><span class=sidebar-button-desc>Categories</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/tags><i class="sidebar-button-icon fa fa-lg fa-tags"></i><span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.deimos.fr/index.xml><i class="sidebar-button-icon fa fa-lg fa-rss"></i><span class=sidebar-button-desc>RSS</span></a></li></ul><ul class=sidebar-buttons></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://www.deimos.fr target=_blank rel=noopener><i class="sidebar-button-icon fa fa-lg fa-user"></i><span class=sidebar-button-desc>About</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://wiki.deimos.fr target=_blank rel=noopener><i class="sidebar-button-icon fa fa-wikipedia-w"></i><span class=sidebar-button-desc>Wiki</span></a></li></ul></div></nav><div id=main data-behavior=5 class=hasCoverMetaIn><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class="post-header main-content-wrap text-left"><h1 class=post-title itemprop=headline>Elasticsearch: How we speed up news feeds and user walls display</h1><div class="postShorten-meta post-meta"><time itemprop=datePublished datetime=2016-01-20T10:00:41Z>20 January 2016</time>
<span>in</span>
<a class=category-link href=https://blog.deimos.fr/categories/developement>Developement</a>,
<a class=category-link href=https://blog.deimos.fr/categories/nousmotards>Nousmotards</a></div></div><div class="post-content markdown" itemprop=articleBody><div class=main-content-wrap><p> </p><p>In <a href=https://blog.deimos.fr/2016/01/15/how-we-use-neo4j-on-our-social-network-and-workaround-performance-issues/>my previous post</a>, I talked about how to speed up reads and writes coupling <a href=http://redis.io/>Redis</a> with <a href=http://neo4j.com/>Neo4J</a>. Now I want to share with you how it&rsquo;s possible to <a href=https://en.wikipedia.org/wiki/Load_(computing)>unload your server</a> and use <a href=https://www.elastic.co/products/elasticsearch>Elasticsearch</a> to speed up news feed and user wall.</p><h3 id=1-show-me-your-news-feed>1/ Show me your news feed</h3><p>A news feed is the main page of traditional social networks. Its main goal is to show you all recents updates from your friends and your interests. <a href=https://www.nousmotards.com>Nousmotards</a> news feed is like any other social networks (facebook, linkedin..), the user&rsquo;s feeds are available from their web browser and their <a href="https://play.google.com/store/apps/details?id=com.nousmotards.android">NM mobile application</a> and it looks like this.</p><p><img src=https://blog.deimos.fr/images/Screen-Shot-2016-01-20-at-00.11.36-535x1024.png alt=Screen-Shot-2016-01-20-at-00.11.36-535x1024></p><p><img src=https://blog.deimos.fr/images/device-2016-01-20-003342-576x1024.png alt=device-2016-01-20-003342-576x1024></p><p> </p><p>As a user, you want to <a href=https://en.wikipedia.org/wiki/EdgeRank>get the more relevant things</a>  and the most updated posts from your friends. And while you are scrolling you want to have the best experience possible. Which means, no glitch/freeze from the UI, no latency while loading images and bunch of news.</p><p><img src=https://blog.deimos.fr/images/more-to-less-relevant.png alt=more-to-less-relevant></p><h3 id=2-first-attempt>2/ First attempt</h3><p>In our first approach <a href=https://blog.deimos.fr/2016/01/15/how-we-use-neo4j-on-our-social-network-and-workaround-performance-issues/>we were using directly Neo4J</a> to read data and display them to the users. Direct access to the database is expensive, 40 concurrent accesses and your server will become so slow than nobody will ever come back.</p><p><img src=https://blog.deimos.fr/images/Screen-Shot-2016-01-19-at-12.18.32-1024x714.png alt=Screen-Shot-2016-01-19-at-12.18.32-1024x714></p><p>I let you imagine the complexity of this, and the effort that the database has to do to respond to the 40 concurrent users, <strong>enrich</strong> them and serialize them all into <a href=https://en.wikipedia.org/wiki/JSON>JSON</a> before sending them to the requester. (note: red dots are users)</p><p>Enrichment is the process of setting some properties depending on who made the request. For instance: Romaric has like a post from Pierre, Romaric request the server to have his feed page, he&rsquo;s retrieving the post that he liked in the same state. Pierre see that his post has been liked by Romaric.</p><p> </p><p>Enrichment processing is very expensive in time, and must be done for each document (10 documents per page) that you want to send to the requester.</p><p><img src=https://blog.deimos.fr/images/enrichments-1.png alt=enrichments-1></p><p> </p><p>4 requesters, 4 read queries in database, 40 enrichments which results to 40 read requests in database more.. server took at best 4 seconds to respond to each of them. Very bad for user experience.. More requesters you have, and more the service take time to respond.. latency ~= <a href=https://en.wikipedia.org/wiki/Big_O_notation>O(n^2)</a> where n is the number of simultaneous requesters..</p><h3 id=3-elasticsearch-to-the-rescue>3/ Elasticsearch to the rescue</h3><p><a href=https://en.wikipedia.org/wiki/Elasticsearch>Elasticsearch</a> is now a very popular documents store solution very used by <a href=https://en.wikipedia.org/wiki/DevOps>OPS</a> and developers. It&rsquo;s commonly used to store logs, search inside them, do sophisticated analytics.. Access times are very good and the product own large <a href=https://www.elastic.co/community>community</a> to make it evolving into the right direction.</p><p>In Nousmotards we are using it for log analytics, monitoring and above all as <strong>feeds and walls cache solution</strong> !</p><p>Instead of directly using Neo4J to ship documents to the user, we have placed Elasticsearch between Neo4j and the &ldquo;core app&rdquo; to retrieve them, then enriching them from Redis before replying to the user_._</p><p><img src=https://blog.deimos.fr/images/1-1.png alt=1-1></p><p> </p><p>Neo4J disappear ? No it&rsquo;s just not used anymore on read requests. Now with 40 concurrent requests we are around 200 and 300ms to reply, that&rsquo;s huge difference ! Neo4J is no more bother by users who get their last updates and can process write requests smoothly. (stats from yesterday, 41245 req, 260ms average request time)</p><p><img src=https://blog.deimos.fr/images/Screen-Shot-2016-01-19-at-17.02.38-209x300.png alt=Screen-Shot-2016-01-19-at-17.02.38-209x300></p><h3 id=4-to-conclude>4/ To conclude</h3><p>Elasticsearch is our life saver, we are using it for more and more things at Nousmotards. In the other hand, it is not a database, you should not use it as your primary datastore ! Corrupt indices may happen and you should be able to reload all your data from scratch. If you know that, you can start to use it at its full potential and with no fear to break things 😉</p><p> </p><p>sources:</p><ul><li><a href=http://kuhess.github.io/presentations/a-news-feed-with-elasticsearch/index.html#/>News feed with Elasticsearch @Viadeo</a></li><li><a href=http://activitystrea.ms/>Activity Stream</a></li><li><a href=https://code.facebook.com/posts/340384146140520/making-news-feed-nearly-50-faster-on-ios/>News feed performance on iOS @Facebook</a></li><li><a href=https://code.facebook.com/posts/879498888759525/fast-rendering-news-feed-on-android/>News feed performance on Android @Facebook</a></li></ul><p>To get more informations on nousmotards: <a href=http://blog.nousmotards.com>blog.nousmotards.com</a></p><p>Join us ! :-)</p><p><img src=https://blog.deimos.fr/images/nm-app-all-screenshots-1024x292.png alt=nm-app-all-screenshots-1024x292></p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=https://blog.deimos.fr/tags/nousmotards/>nousmotards</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2016/01/21/zero-downtime-upgrade-with-ansible-and-haproxy/ data-tooltip="Zero downtime upgrade with Ansible and HAProxy"><i class="fa fa-angle-left"></i><span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2016/01/15/how-we-use-neo4j-on-our-social-network-and-workaround-performance-issues/ data-tooltip="How we use Neo4J on our social network and workaround performance issues"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/"><i class="fa fa-twitter"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#disqus_thread><i class="fa fa-comment-o"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-list"></i></a></li></ul></div><div id=disqus_thread><noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2020 Pierre Mavro / Deimosfr. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=5><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2016/01/21/zero-downtime-upgrade-with-ansible-and-haproxy/ data-tooltip="Zero downtime upgrade with Ansible and HAProxy"><i class="fa fa-angle-left"></i><span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.deimos.fr/2016/01/15/how-we-use-neo4j-on-our-social-network-and-workaround-performance-issues/ data-tooltip="How we use Neo4J on our social network and workaround performance issues"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2016/01/20/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch/"><i class="fa fa-twitter"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#disqus_thread><i class="fa fa-comment-o"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-list"></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=5><i id=btn-close-shareoptions class="fa fa-close"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.deimos.fr%2F2016%2F01%2F20%2Fhow-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch%2F"><i class="fa fa-facebook-official"></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fblog.deimos.fr%2F2016%2F01%2F20%2Fhow-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch%2F"><i class="fa fa-twitter"></i><span>Share on Twitter</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-remove"></i></div><img id=about-card-picture src="https://www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author's picture"><h4 id=about-card-name>Pierre Mavro / Deimosfr</h4><div id=about-card-job><i class="fa fa-briefcase"></i><br>Qovery Co-Founder and CTO</div><div id=about-card-location><i class="fa fa-map-marker"></i><br>Paris - France</div></div></div><div id=cover style=background-image:url(https://blog.deimos.fr/images/fish_background.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin=anonymous></script><script src=https://blog.deimos.fr/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js></script><script src=https://blog.deimos.fr/js/custom.js></script><script lang=javascript>window.onload=updateMinWidth;window.onresize=updateMinWidth;document.getElementById("sidebar").addEventListener("transitionend",updateMinWidth);function updateMinWidth(){var sidebar=document.getElementById("sidebar");var main=document.getElementById("main");main.style.minWidth="";var w1=getComputedStyle(main).getPropertyValue("min-width");var w2=getComputedStyle(sidebar).getPropertyValue("width");var w3=getComputedStyle(sidebar).getPropertyValue("left");main.style.minWidth=`calc(${w1} - ${w2} - ${w3})`;}</script><script>$(document).ready(function(){hljs.configure({classPrefix:'',useBR:false});$('pre.code-highlight > code, pre > code').each(function(i,block){if(!$(this).hasClass('codeblock')){$(this).addClass('codeblock');}
hljs.highlightBlock(block);});});</script><script>var disqus_config=function(){this.page.url='https:\/\/blog.deimos.fr\/2016\/01\/20\/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch\/';this.page.identifier='\/2016\/01\/20\/how-we-speed-up-news-feed-and-user-wall-display-using-elasticsearch\/'};(function(){if(window.location.hostname=="localhost"){return;}
var d=document,s=d.createElement('script');var disqus_shortname='blog-deimosfr';s.src='//'+disqus_shortname+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script></body></html>