

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.30 with theme Tranquilpeak 0.4.3-BETA">
    <title>Packer: build multiple images easily</title>
    <meta name="author" content="Pierre Mavro / Deimosfr">
    <meta name="keywords" content="">

    <link rel="icon" href="https://blog.deimos.fr/favicon.png">
    

    
    <meta name="description" content="Packer is one of the tools I&rsquo;ve used in the past to build VirtualBox boxes. You can find what I&rsquo;ve done on my GitHub account.
For Smash project, I wanted to make a packer configuration to manage Docker and VirtualBox. I also wanted to call Ansible to build specific images for each needs. The goal is to be able to build cloud image ready to start, without any special dependencies. This because I need different usages:">
    <meta property="og:description" content="Packer is one of the tools I&rsquo;ve used in the past to build VirtualBox boxes. You can find what I&rsquo;ve done on my GitHub account.
For Smash project, I wanted to make a packer configuration to manage Docker and VirtualBox. I also wanted to call Ansible to build specific images for each needs. The goal is to be able to build cloud image ready to start, without any special dependencies. This because I need different usages:">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Packer: build multiple images easily">
    <meta property="og:url" content="/2015/01/16/packer-build-multiple-images-easily/">
    <meta property="og:site_name" content="Deimosfr Blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Deimosfr Blog">
    <meta name="twitter:description" content="Packer is one of the tools I&rsquo;ve used in the past to build VirtualBox boxes. You can find what I&rsquo;ve done on my GitHub account.
For Smash project, I wanted to make a packer configuration to manage Docker and VirtualBox. I also wanted to call Ansible to build specific images for each needs. The goal is to be able to build cloud image ready to start, without any special dependencies. This because I need different usages:">
    
      <meta name="twitter:creator" content="@deimosfr">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=640">
    

    
      <meta property="og:image" content="https://blog.deimos.fr/thumbnails/logo_packer.png">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://blog.deimos.fr/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      
        <link rel="stylesheet" href="https://blog.deimos.fr/css/custom.css">
      
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63927289-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://blog.deimos.fr/">Deimosfr Blog</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://blog.deimos.fr/#about">
    
    
    
      
        <img class="header-picture" src="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://blog.deimos.fr/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Pierre Mavro / Deimosfr</h4>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.deimos.fr/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.deimos.fr" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-user"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://wiki.deimos.fr" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-wikipedia-w"></i>
      
      <span class="sidebar-button-desc">Wiki</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Packer: build multiple images easily
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2015-01-16T11:00:52Z">
        
  
  
  
  
    16 January 2015
  

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://blog.deimos.fr/categories/ansible">Ansible</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/debian">Debian</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/docker">Docker</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/hi-tech">Hi-Tech</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/linux">Linux</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/red-hat">Red Hat</a>, 
    
      <a class="category-link" href="https://blog.deimos.fr/categories/virtualization">Virtualization</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p><img src="https://blog.deimos.fr/images/logo_packer.png" alt="packer" />
Packer is one of the tools <a href="http://blog.deimos.fr/2014/03/18/packer-win-time-by-easily-testing-your-app-on-multiple-platforms/" target="_blank">I&rsquo;ve used in the past</a> to build VirtualBox boxes. You can find what I&rsquo;ve done <a href="https://github.com/deimosfr/packer-wheezy" target="_blank">on my GitHub account</a>.</p>

<p>For <a href="http://www.usmash.me/" target="_blank">Smash</a> project, I wanted to make a packer configuration to manage Docker and VirtualBox. I also wanted to call Ansible to build specific images for each needs. The goal is to be able to build cloud image ready to start, without any special dependencies. This because I need different usages:</p>

<ul>
<li>Production: multiple images for the cloud (VM/Container)</li>
<li>CI: multiple images using Docker</li>
<li>Dev: multiple images using Docker or VirtualBox</li>
</ul>

<p>I did not started to manage the cloud provider for the moment as I&rsquo;m not sure which one I&rsquo;ll be using. Anyway it won&rsquo;t be complicated as the biggest part has been done here. First of all, I declared the default vars in the Packer file:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#e6db74">&#34;variables&#34;</span><span style="color:#f92672">:</span> {
        <span style="color:#e6db74">&#34;debian_version&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;7.7.0&#34;</span>,
        <span style="color:#e6db74">&#34;iso_checksum&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5cb6e4fea55fbb5173f90c3a545b843c6c193e29c3aa32b3306c9bbdfb1ad6a6a36ae8be50e91af9d03d5f21c472bd05d04d3508172e0b519e76714333c7c74b&#34;</span>,
        <span style="color:#e6db74">&#34;ansible_inventory_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ansible_inventory_file&#34;</span>,
        <span style="color:#e6db74">&#34;ansible_environment&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;dev&#34;</span>,
        <span style="color:#e6db74">&#34;soft_version&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;noversion&#34;</span>
    },</code></pre></div>

<p>Here I specified the Debian version which will be automatically downloaded by Packer (for VirtualBox). Then the Ansible inventory file which is containing the group of hosts where the generated image will belong to. Example:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[web]</span>
<span style="color:#a6e22e">127.0.0.1</span>

<span style="color:#66d9ef">[webapp]</span>

<span style="color:#75715e">#[sql]</span>
<span style="color:#75715e">#127.0.0.1</span></code></pre></div>

<p>Then we are declaring the 2 builders. The first one for VirtualBox and the second for Docker:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#e6db74">&#34;builders&#34;</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>,
      <span style="color:#e6db74">&#34;boot_command&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;&lt;esc&gt;&lt;wait&gt;&#34;</span>,
...
      <span style="color:#e6db74">&#34;vboxmanage&#34;</span><span style="color:#f92672">:</span> [
        [ <span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--memory&#34;</span>, <span style="color:#e6db74">&#34;512&#34;</span> ],
        [ <span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--cpus&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span> ]
      ]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;docker&#34;</span>,
      <span style="color:#e6db74">&#34;image&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;debian:wheezy&#34;</span>,
      <span style="color:#e6db74">&#34;export_path&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;debian.tar&#34;</span>
    }
  ],</code></pre></div>

<p>We&rsquo;re calling here the desired version of Debian image in the variables. The automated installation of VirtualBox is ensured by Debian <a href="https://github.com/deimosfr/packer-wheezy/blob/master/http/preseed.cfg" target="_blank">preseed.</a> VirtualBox will also pass required args to Debian grub boot for preseed. Regarding Docker, it&rsquo;s simpler as it will automatically pull from the official Docker repository the required distribution.</p>

<p>Then you need to use post processor to request the output format from Packer. Here for VirtualBox, I require an export in a .box format with a maximum compression level. And for Docker, I add the image locally to my  list of images:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#e6db74">&#34;post-processors&#34;</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#e6db74">&#34;compression_level&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;9&#34;</span>,
      <span style="color:#e6db74">&#34;output&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;wheezy_{{user `debian_version`}}-{{user `soft_version`}}.box&#34;</span>,
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;docker-import&#34;</span>,
      <span style="color:#e6db74">&#34;repository&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smash&#34;</span>,
      <span style="color:#e6db74">&#34;tag&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;wheezy_{{user `debian_version`}}-{{user `soft_version`}}&#34;</span>,
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;docker&#34;</span>]
    }
  ],</code></pre></div>

<p>Regarding the provisioner part, the way to call VirtualBox scripts and Docker are different. VirtualBox uses sudo command while Docker doesn&rsquo;t need it. As you can see, I&rsquo;m executing several scripts (some are the same and others are specific):</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#e6db74">&#34;provisioners&#34;</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;execute_command&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;echo &#39;vagrant&#39; | {{.Vars}} sudo -E -S bash &#39;{{.Path}}&#39;&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/update.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sshd.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/networking.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_prequesites.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sudoers.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/vagrant.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/vbaddguest.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_bin.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/update.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sshd.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/networking.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_prequesites.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sudoers.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/vagrant.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_bin.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;docker&#34;</span>]
    },
    {
        <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ansible-local&#34;</span>,
        <span style="color:#e6db74">&#34;playbook_dir&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;..&#34;</span>,
        <span style="color:#e6db74">&#34;playbook_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;../site.yml&#34;</span>,
        <span style="color:#e6db74">&#34;inventory_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{user `ansible_inventory_file`}}&#34;</span>,
        <span style="color:#e6db74">&#34;extra_arguments&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;-e&#34;</span>, <span style="color:#e6db74">&#34;set_env={{user `ansible_environment`}}&#34;</span>, <span style="color:#e6db74">&#34;-v&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;execute_command&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;echo &#39;vagrant&#39; | {{.Vars}} sudo -E -S bash &#39;{{.Path}}&#39;&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/cleanup.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/cleanup.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;docker&#34;</span>]
    }
  ]
}</code></pre></div>

<p>Ansible is also executed to create a complete image (and specific vars can be added). Of course this is a little bit boring to create a new image on every release (but can be automated), however when your goal is to auto-scale your images in a cloud environment, it&rsquo;s relevant to be not dependent of tier party applications (GitHub, Apt/Yum repo etc&hellip;). That&rsquo;s why this solution is better in my opinion.</p>

<p>If you&rsquo;re wondering what the scripts are doing:</p>

<ul>
<li>&ldquo;scripts/update.sh&rdquo;: install curl</li>
</ul>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>apt-get update
<span style="color:#75715e"># install curl to fix broken wget while retrieving content from secured sites
</span><span style="color:#75715e"></span>apt-get -y install curl</code></pre></div></p>

<ul>
<li>&ldquo;scripts/sshd.sh&rdquo;: install SSH and set 2 options</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>apt-get -y install openssh-server
echo <span style="color:#e6db74">&#34;UseDNS no&#34;</span> &gt;&gt; /etc/ssh/sshd_config
echo <span style="color:#e6db74">&#34;GSSAPIAuthentication no&#34;</span> &gt;&gt; /etc/ssh/sshd_config</code></pre></div>

<ul>
<li>&ldquo;scripts/networking.sh&rdquo;: reset network device interface name</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>rm /etc/udev/rules.d/70-persistent-net.rules
mkdir /etc/udev/rules.d/70-persistent-net.rules
rm /lib/udev/rules.d/75-persistent-net-generator.rules
rm -rf /dev/.udev/ /var/lib/dhcp/*
echo <span style="color:#e6db74">&#34;pre-up sleep 2&#34;</span> &gt;&gt; /etc/network/interfaces</code></pre></div>

<ul>
<li>&ldquo;scripts/ansible_prequesites.sh&rdquo;: install prerequisite for any Ansible client</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Ansible prequesites
</span><span style="color:#75715e"></span>apt-get -y install python ruby ruby-json facter ohai</code></pre></div>

<ul>
<li>&ldquo;scripts/sudoers.sh&rdquo;: install sudo and give to vagrant user all privileges</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>apt-get -y install sudo
<span style="color:#75715e"># Set up password-less sudo for user vagrant
</span><span style="color:#75715e"></span>echo <span style="color:#e6db74">&#39;vagrant ALL=(ALL) NOPASSWD:ALL&#39;</span> &gt; /etc/sudoers.d/vagrant
chmod <span style="color:#ae81ff">440</span> /etc/sudoers.d/vagrant
<span style="color:#75715e"># no tty
</span><span style="color:#75715e"></span>echo <span style="color:#e6db74">&#34;Defaults !requiretty&#34;</span> &gt;&gt; /etc/sudoers</code></pre></div>

<ul>
<li>&ldquo;scripts/vagrant.sh&rdquo;: create vagrant user and add vagrant public key to vagrant user (for VirtualBox) and to root user (for Docker)</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e">### WARNING: DO NOT FORGET TO REMOVE IT IF ACCESSIBLE FROM OUTSIDE !!!
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">function</span> add_vagrant_key <span style="color:#f92672">{</span>
    homedir<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>su - $1 -c <span style="color:#e6db74">&#39;echo $HOME&#39;</span><span style="color:#66d9ef">)</span>
    mkdir -p $homedir/.ssh
    curl -L <span style="color:#e6db74">&#39;https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub&#39;</span> -o $homedir/.ssh/authorized_keys2
    chown -Rf $1. $homedir/.ssh
    chmod <span style="color:#ae81ff">700</span> $homedir/.ssh
    chmod <span style="color:#ae81ff">600</span> $homedir/.ssh/authorized_keys2
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#66d9ef">$(</span>grep -c vagrant /etc/passwd<span style="color:#66d9ef">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    useradd vagrant -m
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># Add public key to vagrant user
</span><span style="color:#75715e"></span>add_vagrant_key vagrant
<span style="color:#75715e"># Needed for vagrant provider using docker
</span><span style="color:#75715e"></span>add_vagrant_key root</code></pre></div>

<ul>
<li>&ldquo;scripts/ansible_bin.sh&rdquo;: install Ansible to be able to run playbooks locally</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># Install backports for wheezy
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#66d9ef">$(</span>grep -c <span style="color:#e6db74">&#34;^7\.&#34;</span> /etc/debian_version<span style="color:#66d9ef">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;deb http://http.debian.net/debian wheezy-backports main&#34;</span> &gt; /etc/apt/sources.list.d/backports.list
    apt-get update
<span style="color:#66d9ef">fi</span>
<span style="color:#75715e"># Install Ansible
</span><span style="color:#75715e"></span>apt-get -y install ansible
touch /var/log/ansible.log
chown vagrant. /var/log/ansible.log</code></pre></div>

<ul>
<li>&ldquo;<a href="https://github.com/deimosfr/packer-wheezy/blob/master/scripts/vbaddguest.sh" target="_blank">scripts/vbaddguest.sh</a>&ldquo;: install virtualbox guests additions</li>
<li>&ldquo;<a href="https://github.com/deimosfr/packer-wheezy/blob/master/scripts/cleanup.sh" target="_blank">scripts/cleanup.sh</a>&ldquo;: cleanup script to reduce the VM/container size</li>
</ul>

<p>Now we&rsquo;re ready to play ! You can have a variables file that will override the default set vars in your Packer file. Example:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#e6db74">&#34;debian_version&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;7.7.0&#34;</span>,
    <span style="color:#e6db74">&#34;iso_checksum&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5cb6e4fea55fbb5173f90c3a545b843c6c193e29c3aa32b3306c9bbdfb1ad6a6a36ae8be50e91af9d03d5f21c472bd05d04d3508172e0b519e76714333c7c74b&#34;</span>,
    <span style="color:#e6db74">&#34;ansible_inventory_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ansible_inventory_file&#34;</span>,
    <span style="color:#e6db74">&#34;ansible_environment&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;prod&#34;</span>,
    <span style="color:#e6db74">&#34;soft_version&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;0.1&#34;</span>
}</code></pre></div>

<p>Now if I want to create an exported VirtualBox .box with default vars, I only have to run:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">packer build -only<span style="color:#f92672">=</span>virtualbox-iso packerfile</code></pre></div>

<p>And if I want a Docker container added to your images with my custom vars:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">packer build -only<span style="color:#f92672">=</span>docker -var-file<span style="color:#f92672">=</span>packer_vars packerfile</code></pre></div>

<p>If you do not specify an output format, it will build both in parallel :-)</p>

<p>Here is the complete packerfile:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#e6db74">&#34;variables&#34;</span><span style="color:#f92672">:</span> {
        <span style="color:#e6db74">&#34;debian_version&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;7.7.0&#34;</span>,
        <span style="color:#e6db74">&#34;iso_checksum&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5cb6e4fea55fbb5173f90c3a545b843c6c193e29c3aa32b3306c9bbdfb1ad6a6a36ae8be50e91af9d03d5f21c472bd05d04d3508172e0b519e76714333c7c74b&#34;</span>,
        <span style="color:#e6db74">&#34;ansible_inventory_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ansible_inventory_file&#34;</span>,
        <span style="color:#e6db74">&#34;ansible_environment&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;dev&#34;</span>,
        <span style="color:#e6db74">&#34;soft_version&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;noversion&#34;</span>
    },
  <span style="color:#e6db74">&#34;builders&#34;</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>,
      <span style="color:#e6db74">&#34;boot_command&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;&lt;esc&gt;&lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;install &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;debian-installer=en_US &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;auto &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;locale=en_US &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;kbd-chooser/method=us &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;keyboard-configuration/xkb-keymap=us &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;netcfg/get_hostname={{ .Name }} &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;netcfg/get_domain=vagrantup.com &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;fb=false &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;debconf/frontend=noninteractive &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;console-setup/ask_detect=false &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;console-keymaps-at/keymap=us &lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;&lt;enter&gt;&lt;wait&gt;&#34;</span>
      ],
      <span style="color:#e6db74">&#34;boot_wait&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;10s&#34;</span>,
      <span style="color:#e6db74">&#34;disk_size&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">32768</span>,
      <span style="color:#e6db74">&#34;guest_os_type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Debian_64&#34;</span>,
      <span style="color:#e6db74">&#34;headless&#34;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
      <span style="color:#e6db74">&#34;http_directory&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http&#34;</span>,
      <span style="color:#e6db74">&#34;iso_checksum&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{user `iso_checksum`}}&#34;</span>,
      <span style="color:#e6db74">&#34;iso_checksum_type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sha512&#34;</span>,
      <span style="color:#e6db74">&#34;iso_url&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://cdimage.debian.org/cdimage/release/{{user `debian_version`}}/amd64/iso-cd/debian-{{user `debian_version`}}-amd64-netinst.iso&#34;</span>,
      <span style="color:#e6db74">&#34;ssh_username&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#e6db74">&#34;ssh_password&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#e6db74">&#34;ssh_port&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
      <span style="color:#e6db74">&#34;ssh_wait_timeout&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;10000s&#34;</span>,
      <span style="color:#e6db74">&#34;shutdown_command&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;echo &#39;vagrant&#39;|sudo -S /sbin/shutdown -hP now&#34;</span>,
      <span style="color:#e6db74">&#34;guest_additions_path&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;VBoxGuestAdditions_{{.Version}}.iso&#34;</span>,
      <span style="color:#e6db74">&#34;virtualbox_version_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;.vbox_version&#34;</span>,
      <span style="color:#e6db74">&#34;vm_name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;debian-{{user `debian_version`}}-amd64&#34;</span>,
      <span style="color:#e6db74">&#34;vboxmanage&#34;</span><span style="color:#f92672">:</span> [
        [ <span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--memory&#34;</span>, <span style="color:#e6db74">&#34;512&#34;</span> ],
        [ <span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--cpus&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span> ]
      ]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;docker&#34;</span>,
      <span style="color:#e6db74">&#34;image&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;debian:wheezy&#34;</span>,
      <span style="color:#e6db74">&#34;export_path&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;debian.tar&#34;</span>
    }
  ],
  <span style="color:#e6db74">&#34;post-processors&#34;</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#e6db74">&#34;compression_level&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;9&#34;</span>,
      <span style="color:#e6db74">&#34;output&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;wheezy_{{user `debian_version`}}-{{user `soft_version`}}.box&#34;</span>,
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;docker-import&#34;</span>,
      <span style="color:#e6db74">&#34;repository&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smash&#34;</span>,
      <span style="color:#e6db74">&#34;tag&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;wheezy_{{user `debian_version`}}-{{user `soft_version`}}&#34;</span>,
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;docker&#34;</span>]
    }
  ],
  <span style="color:#e6db74">&#34;provisioners&#34;</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;execute_command&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;echo &#39;vagrant&#39; | {{.Vars}} sudo -E -S bash &#39;{{.Path}}&#39;&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/update.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sshd.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/networking.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_prequesites.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sudoers.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/vagrant.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/vbaddguest.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_bin.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/update.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sshd.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/networking.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_prequesites.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/sudoers.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/vagrant.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/ansible_bin.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;docker&#34;</span>]
    },
    {
        <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ansible-local&#34;</span>,
        <span style="color:#e6db74">&#34;playbook_dir&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;..&#34;</span>,
        <span style="color:#e6db74">&#34;playbook_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;../site.yml&#34;</span>,
        <span style="color:#e6db74">&#34;inventory_file&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{user `ansible_inventory_file`}}&#34;</span>,
        <span style="color:#e6db74">&#34;extra_arguments&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;-e&#34;</span>, <span style="color:#e6db74">&#34;set_env={{user `ansible_environment`}}&#34;</span>, <span style="color:#e6db74">&#34;-v&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;execute_command&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;echo &#39;vagrant&#39; | {{.Vars}} sudo -E -S bash &#39;{{.Path}}&#39;&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/cleanup.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>]
    },
    {
      <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#34;scripts/cleanup.sh&#34;</span>
      ],
      <span style="color:#e6db74">&#34;only&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;docker&#34;</span>]
    }
  ]
}</code></pre></div>

<p>Thanks again to Hashicorp and hope you enjoyed explanations !</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/ansible/">ansible</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/debian/">debian</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/docker/">docker</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/packer/">packer</a>

  <a class="tag tag--primary tag--small" href="https://blog.deimos.fr/tags/virtualbox/">virtualbox</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2015/01/20/simple-ec2-snapshot-released/" data-tooltip="Simple EC2 snapshot released !">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2015/01/13/vagrant-provision-vms-and-containers-with-ansible/" data-tooltip="Vagrant: provision vms and containers with Ansible">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2015/01/16/packer-build-multiple-images-easily/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2015/01/16/packer-build-multiple-images-easily/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://blog.deimos.fr/2015/01/16/packer-build-multiple-images-easily/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2018 Pierre Mavro / Deimosfr. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2015/01/20/simple-ec2-snapshot-released/" data-tooltip="Simple EC2 snapshot released !">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://blog.deimos.fr/2015/01/13/vagrant-provision-vms-and-containers-with-ansible/" data-tooltip="Vagrant: provision vms and containers with Ansible">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.deimos.fr/2015/01/16/packer-build-multiple-images-easily/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.deimos.fr/2015/01/16/packer-build-multiple-images-easily/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://blog.deimos.fr/2015/01/16/packer-build-multiple-images-easily/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.deimos.fr%2F2015%2F01%2F16%2Fpacker-build-multiple-images-easily%2F">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fblog.deimos.fr%2F2015%2F01%2F16%2Fpacker-build-multiple-images-easily%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fblog.deimos.fr%2F2015%2F01%2F16%2Fpacker-build-multiple-images-easily%2F">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/194382a6478d109ac45c9b11bad1945e?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Pierre Mavro / Deimosfr</h4>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        SRE Lead DevOps at Criteo &nbsp;&bull;&nbsp; MySocialApp Co-Founder
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Paris - France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/06/24/running-cassandra-on-kubernetes/">
                <h3 class="media-heading">Running Cassandra in Kubernetes</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">For my own company MySocialApp, I&rsquo;m managing multiple Cassandra clusters on top of a Kubernetes on premise cluster. For those who never heard of this distributed database, here is the summary from the official website:
 The Apache Cassandra database is the right choice when you need scalability and high availability without compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure make it the perfect platform for mission-critical data.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/31/integrate-gcr-in-your-on-premise-kubernetes/">
                <h3 class="media-heading">Integrate GCR in your on premise k8s cluster</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">I&rsquo;m using Kubernetes on an on premise cluster for MySocialApp. Today, I&rsquo;m storing MySocialApp public images at Quay.io and I also wanted to store private images. I didn&rsquo;t want to bootstrap a private registry for it to avoid maintaining it, having a distributed storage to maintain for it etc&hellip;but wanted a solution at a lower cost.
I started to look at DockerHub and Quay.io. As far aas I saw, DockerHub do not provide private registry while Quay does.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/26/install-jeedom-on-synology-with-docker/">
                <h3 class="media-heading">Install Jeedom on Synology with Docker</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">The Jeedom software is open source; you have complete access to the software that manages your home automation. Jeedom is compatible with various protocols, like Z-Wave, RFXCOM, RTS SOMFY, EnOcean, xPL, etc.
Installing Jeedom on Synology with Docker it not a complex task. However for those who are not familiar with those technologies, I summarized here the installation process for a Z-wave network.
First of all, let&rsquo;s look at the requirements:</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/23/traefik-ha-helm-chart-with-le-on-k8s/">
                <h3 class="media-heading">Traefik HA Helm chart with Let&#39;s Encrypt on Kubernetes</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
In a previous post, I explained how to manually deploy it in HA mode. For MySocialApp (iOS and Android social app builder - SaaS), I had to automate it.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2018/01/18/mysocialapp-crate-your-own-social-network/">
                <h3 class="media-heading">MySocialApp Create your own social network</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">If you follow me, you may know that I launched with friends Nousmotards social application a few years ago. The solution continue to grow in France with more than 70k bikers and that&rsquo;s a good point for all those riders :)
Since we launched Nousmotards, several persons asked us: &ldquo;You&rsquo;ve made an amazing job for bikers, do you provide your social solution to any other communities or for enterprises?&rdquo;. The answer was: No we didn&rsquo;t.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2017/08/20/kubernetes-with-traefik-and-lets-encrypt/">
                <h3 class="media-heading">Kubernetes with Traefik and Let&#39;s Encrypt</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Traefik (pronounced like traffic) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease. It supports several backends (Docker, Swarm, Kubernetes, Marathon, Mesos, Consul, Etcd, Zookeeper, BoltDB, Eureka, Amazon DynamoDB, Rest API, file…) to manage its configuration automatically and dynamically.
I wanted to deploy it on Kubernetes for its interesting features like:
 Connect to Kubernetes API to listen changes and perform on the fly updates Automatic SSL management through Let&rsquo;s encrypt (SNI) Prometheus native integration HTTP/2 support  I really like HAProxy, but in a Kubernetes case, it&rsquo;s not the recommended solution because of its lake of features.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2017/04/18/deploy-kubernetes-with-ansible/">
                <h3 class="media-heading">Deploy Kubernetes with Ansible</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications. I&rsquo;m using it for Nousmotards and decided to build an Ansible role for it to make it simpler to deploy.
Why did I built it as other projects like Kargo already exists? I just wanted a simple and maintainable role based on CoreOS official documentation. That&rsquo;s what I did:
 This role bootstrap a Kubernetes cluster based on CoreOS Container Linux for production usages.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2017/04/18/blog-migrated-to-hugo-on-github/">
                <h3 class="media-heading">Blog migrated to Hugo on Github</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">As you certainly seen, the blog has been migrated :-). Visualy there is a big change and technically it&rsquo;s the same.
I was fed up about maintaining Wordpress with its stack (Nginx / php-fpm / MariaDB) for a mostly static blog. I was thinking about migrating from Wordpress to something in markdown since several years but didn&rsquo;t know exactly which solution I wanted to choose. I really enjoyed using Wordpress but wanted to keep hands on my blog and didn&rsquo;t want to switch to full hosted Wordpress because of its limitations (image size etc&hellip;).</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2016/09/30/deploy-coreos-with-ansible/">
                <h3 class="media-heading">Deploy CoreOS with Ansible</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Sep 9, 2016
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">&nbsp;
CoreOS is a lightweight Linux operating system designed for clustered deployments providing automation, security, and scalability for your most critical applications.&nbsp;I&rsquo;ve been playing with CoreOS to replace Debian hosts which run Docker containers on Nousmotards project. CoreOS helps on simplifying bare metal deployment and avoid managing OS upgrade.
As I&rsquo;m still an Ansible lover, I&rsquo;ve made 2 roles:
 CoreOS Ansible:&nbsp;Ansible role to deploy pypy to CoreOS to be able to get Ansible prerequisites CoreOS: Ansible CoreOS role to deploy CoreOS on bare metal servers  If you want to quickly look at the result:</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://blog.deimos.fr/2016/06/18/do-not-waste-time-with-grep-anymore-use-tag/">
                <h3 class="media-heading">Do not waste time with grep anymore, use tag</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2016
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Long time since my last post. This one is not very technical post, but it&rsquo;s a nice to have solution if you use grep usually. Are not you fed up to type vim  and search the line after a grep command ? If yes, this post is for you.
First of all, you may know that an alternative more user friendly to grep exist, called ag (perf comparison). I really like ag and grep, but something make me loose my time since several years and I&rsquo;m pretty sure it&rsquo;s your case too.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         840 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://blog.deimos.fr/images/fish_background.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://blog.deimos.fr/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>




  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/blog.deimos.fr\/2015\/01\/16\/packer-build-multiple-images-easily\/';
          
            this.page.identifier = '\/2015\/01\/16\/packer-build-multiple-images-easily\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'blog-deimosfr';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

